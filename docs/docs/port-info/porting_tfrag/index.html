<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-port-info/porting_tfrag">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/shoelace.js" type="module"></script><title data-rh="true">Porting Tfrag | OpenGOAL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://open-goal.github.io/docs/port-info/porting_tfrag"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Porting Tfrag | OpenGOAL"><meta data-rh="true" name="description" content="Tfrag is the renderer for non-instanced background geometry. It&#x27;s typically used for the floor and unique walls/level geometry. It has a level of detail system, and time of day lighting, optionaly transparancy and that&#x27;s it. No other features."><meta data-rh="true" property="og:description" content="Tfrag is the renderer for non-instanced background geometry. It&#x27;s typically used for the floor and unique walls/level geometry. It has a level of detail system, and time of day lighting, optionaly transparancy and that&#x27;s it. No other features."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://open-goal.github.io/docs/port-info/porting_tfrag"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/port-info/porting_tfrag" hreflang="en"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/port-info/porting_tfrag" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.09ceced1.css">
<link rel="preload" href="/assets/js/runtime~main.b80e7d5d.js" as="script">
<link rel="preload" href="/assets/js/main.1d3489b1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OpenGOAL</b></a><a class="navbar__item navbar__link" href="/progress">Progress</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/open-goal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">An Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/language-reference">Language Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Language Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/usage">Usage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Usage&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/developing">Developing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/pc-port-info">PC Port Info</a><button aria-label="Toggle the collapsible sidebar category &#x27;PC Port Info&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/port-info/graphics">Graphics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/port-info/drawable_and_tfrag">drawable_and_tfrag</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/port-info/tfrag">Basic Process for Drawing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/port-info/porting_tfrag">Porting Tfrag</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/pc-port-info"><span itemprop="name">PC Port Info</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Porting Tfrag</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Porting Tfrag</h1><p>Tfrag is the renderer for non-instanced background geometry. It&#x27;s typically used for the floor and unique walls/level geometry. It has a level of detail system, and time of day lighting, optionaly transparancy and that&#x27;s it. No other features.</p><p>The approach I took was to go slowly and understand the rendering code. I made two different &quot;test&quot; renderers that were slow but did things exactly the same way as in the PS2 version.  After this, I made a custom PC version called tfrag3. The key difference with tfrag3 is that there is an offline preprocessing step that reads the level data and outputs data in a good format for PC.</p><p>Trying to understand the rendering code is annoying, but I think it was worth it in the end.</p><ul><li>you can often leave out huge chunks of code. I never touched <code>tfrag-near</code> or most of the <code>tfrag</code> VU program.</li><li>you can eventually figure out how move more to the GPU. For example, all clipping/scissoring and transformation is done on the GPU. This is faster (GPUs are good) and easier (OpenGL does it automatically if you set it up right, you don&#x27;t have to do the math).</li><li>you can rearrange things for better performance. Keeping the number of OpenGL draw calls down is probably the best thing we can do for performance.</li></ul><p>But in order to understand the renderer, I had to start with a slow &quot;emulation-like&quot; port.</p><p>This document is divided into three parts:</p><ol><li>PS2 rendering (in Jak).</li><li>Jak&#x27;s <code>drawable</code> system</li><li>Tfrag-specific details</li></ol><h1>Basics of PS2 Rendering</h1><p>The main idea of the Jak rendering system is that there are always two frames in progress at a time.  One frame is being &quot;rendered&quot; meaning triangles are being transformed and rasterized and the VRAM is being written to.  The other frame is being &quot;calculated&quot;, meaning the game is building the list of instructions to draw the frame.  The &quot;calculation&quot; happens from GOAL code, mostly on the EE, and builds a single giant &quot;DMA chain&quot;.  At the end of a frame, the engine takes the full DMA chain that was built, and sends it to the rendering hardware. The rendering process is all &quot;automatic&quot; - once it gets the list of data it will run for an entire frame and do all of the drawing.</p><p>The EE user manual sections for DMAC, VPU (VU), and GIF are worth reading before trying to understand new rendering code.</p><p>Because the calculation and rendering happen simultaneously, the calculation cannot use the same hardware and memory as the rendering.  The following resources are used only by rendering:</p><ul><li>VU1</li><li>VIF1</li><li>GIF</li><li>GS</li></ul><p>The following resources are used only by calculation:</p><ul><li>VU0-macro mode (<code>vf</code> register on EE and <code>vadd</code> like instructions)</li><li>VU0-micro mode</li><li>VIF0</li><li>The scratchpad</li></ul><p>The following resources are shared:</p><ul><li>DMA controller. It can handle multiple transfers to different places at the same time, and there are no shared destinations, so there&#x27;s no issue here.  Rendering uses only to VIF1. Calculation uses to VIF0, to scratchpad, and from scratchpad.</li><li>The &quot;global&quot; DMA buffer. The calculation process fills this buffer and the rendering reads from it. There are two copies of this buffer and the engine will swap them automatically at the end of the frame. So one copy is always being filled while the other is being read and the graphics code mostly doesn&#x27;t worry about this.</li><li>DMA data inside of level data. The DMA list may include chunks of data that&#x27;s part of the level data. In practice there&#x27;s not much to be aware of here - the rendering process just reads this data. </li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dma">DMA<a class="hash-link" href="#dma" title="Direct link to heading">​</a></h2><p>The whole rendering system is driven by DMA. The DMA controller can copy data from main memory to different peripherals. If the destination is &quot;busy&quot;, it will wait. So it doesn&#x27;t just blindly dump data into things as fast as it can - it only sends data if the destination is ready to accept it. The DMA controller is controlled by &quot;DMA tags&quot;. These contain a command like &quot;transfer X bytes of data from address Y, then move on to the DMA tag at address Z&quot;. This allows the game to build up really complicated linked-lists of data to send.</p><p>The DMA list built for rendering is divided into buckets. See <code>dma-h.gc</code> for the bucket names. Individual renderers add data to buckets, and then the buckets are linked together in the order they are listed in that enum. Code like <code>tfrag</code> won&#x27;t start DMA to VIF1 or deal with linking buckets - that is handled by the game engine.</p><p>However, code like <code>tfrag</code> may just set up its own transfers to/from SPR and VIF0 - these are free-to-use during the &quot;calculation&quot; step.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-vif">The VIF<a class="hash-link" href="#the-vif" title="Direct link to heading">​</a></h2><p>The VIF is &quot;vector unit interface&quot;. There&#x27;s one for VU0 and VU1 and they are (as far as I know) identical. The rendering DMA list is sent directly to VIF1. There are also &quot;tags&quot; that control the VIF. The general types of tags are:</p><ul><li>&quot;take the following N bytes of data and copy it to VU data memory&quot; (possibly with some fancy &quot;unpacking&quot; operation to move stuff around)</li><li>&quot;take the following N bytes of data and copy it to VU program memory&quot; - to upload a new VU program</li><li>&quot;run a VU program starting at this address in VU program memory&quot;</li><li>&quot;send this data <strong>direct</strong>ly to the GIF&quot; This is called a &quot;direct&quot; transfer. It&#x27;s typically used to set things up on the GS that will be constant for one specific renderer.</li></ul><p>I haven&#x27;t seen VIF0 really used much. The pattern for VIF1 is usually:</p><ol><li>upload program</li><li>upload some constants</li><li>upload some model data</li><li>run program</li><li>repeat steps 3 and 4 many times</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="vu-programs">VU programs<a class="hash-link" href="#vu-programs" title="Direct link to heading">​</a></h2><p>The VU programs are usually responsible for transforming vertices with the camera matrix, clipping, lighting calculations, etc. The output of a VU program is GIF packets containing the actual drawing information (transformed vertices, drawing settings, etc).</p><p>The usual pattern is that the VU program will build up a GIF packet, then use the <code>XGKICK</code> instruction with the address of the start of the packet. This will start transferring the packet directly to the GIF. The transfer happens in the background. The transfer will only be completed once all triangles are drawn - there&#x27;s no buffer on the GIF/GS. A single packet can be pretty big and have many triangles.</p><p>For the tfrag1/tfrag2 renderers, I ported up to this part. Then, I sent the <code>xgkick</code> data to the <code>DirectRenderer</code> which can handle this format of data. It is not super fast, but it&#x27;s nice for debugging. Being able to inspect this was helpful to understand how it works.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="vu-buffer-hell">VU buffer hell<a class="hash-link" href="#vu-buffer-hell" title="Direct link to heading">​</a></h2><p>Typically the VU programs have 4 buffers. There is a buffer for input and output data, and both are double buffered. This allows you to be uploading new data with DMA, transforming vertices, and sending data to the GIF all at the same time. </p><p>All 4 buffers are in use at the same time.</p><ol><li>Untransformed Data being uploaded from the DMA list to VU data. This happens automatically by DMA.</li><li>Untransformed Data being transformed by the VU1 program.</li><li>A GIF packet being built from the output of the transformation. This is written by the VU1 program.</li><li>A GIF packet currently being <code>XGKICK</code>ed.</li></ol><p>Once 1 is full and 2 is totally used, these buffers are swapped. The same thing happens for 3 and 4.
In some renderers, these swaps are always done at the same time. For example <code>sprite</code>. This tends to use the built-in <code>xitop</code> instructions for managing double buffering.</p><p>In other renderers, the buffer swaps can happen at different times. This leads to awful code where you have 4 different versions of the same renderer for all possible combinations of which buffers are input/output. Storing the address of the input/output buffer in a variable can lead to extra instructions inside the transformation loops, which will significantly slow down.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gif">GIF<a class="hash-link" href="#gif" title="Direct link to heading">​</a></h2><p>The GIF can receive commands like:</p><ul><li>&quot;set the alpha blending mode to X&quot;</li><li>&quot;use texture located at VRAM address Y&quot;</li><li>&quot;draw a triangle&quot;</li></ul><p>It can&#x27;t do any transformation or lighting calculations.</p><h1>Jak <code>drawable</code> system</h1><p>There is a <code>drawable</code> system that&#x27;s used to store things that can be &quot;drawn&quot;. It uses a tree structure. So you can do something like</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(draw some-level)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and it will recursively go through the entire level&#x27;s tree of drawables and draw everything.  Note that there are a lot of tricks/hacks so not every <code>drawable</code> supports <code>draw</code> and some code may defer some <code>draw</code>s until later.</p><p>The lowest-level drawable for tfrag is <code>tfragment</code>. It makes sense to split up the level into &quot;fragments&quot; because the entire level is way too big to fit in the VU memory. Most of the time, you can&#x27;t see every triangle in the level, so it makes sense to skip uploading the fragments that you know can&#x27;t be seen.
There are thousands of these fragments. They tend to be ~ a few kB and each contains a chunk of data to upload to the VUs.  Note that <code>draw</code> is not called directly on <code>tfragment</code>, despite the fact that they are <code>drawable</code>s (more details later).  The <code>tfragment</code> is just a reference to some DMA data.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="drawables-for-tfrag">Drawables for Tfrag<a class="hash-link" href="#drawables-for-tfrag" title="Direct link to heading">​</a></h2><p>The top-level drawable type for an entire level is <code>bsp-header</code>. This is the type of the <code>-vis</code> file of the level&#x27;s DGO, and has all the graphics data (not including textures). It is also a <code>drawable</code>.</p><p>Within <code>bsp-header</code> is a <code>drawable-tree-array</code>. As the name implies, this contains an array of <code>drawable-tree</code>. Usually there are 5-10 of these in a level. There will be a <code>drawable-tree</code> for each renderer. Or possibly a few per renderer, if that renderer supports different modes.  For example there&#x27;s one for tfrag, one for transparent tfrag, one for tie, etc.</p><p>You can just check the type of the <code>drawable-tree</code> to see if it&#x27;s for tfrag/tie etc. The tfrag types are:</p><ul><li><code>drawable-tree-tfrag</code> (parent of the rest)</li><li><code>drawable-tree-trans-tfrag</code></li><li><code>drawable-tree-dirt-tfrag</code></li><li><code>drawable-tree-ice-tfrag</code></li><li><code>drawable-tree-lowres-tfrag</code></li><li><code>drawable-tree-lowres-trans-tfrag</code></li></ul><p>Each &quot;tree&quot; contains a bunch of <code>tfragment</code>s and a time of day color palette.  But they are stored in a really weird way. There is a bounding volume hierarchy of <code>tfragment</code>s. This is just a tree-like structure where each node stores a sphere, and all the node&#x27;s children fit inside of that sphere. The nodes at each depth are stored in an array. The layout of this tree is designed to let them use some crazy assembly SIMD 8-at-a-time traversal of the tree, with minimal pointer-chasing and good memory access patterns.</p><p>Each tree has an array of <code>drawable-inline-array</code>s, storing all the nodes at a given depth. The last <code>drawable-inline-array</code> is actually a <code>drawable-inline-array-frag</code>, which is a wrapper around an inline array of <code>tfragment</code>s.</p><p>The other arrays are used to store tree nodes to organize these <code>tfragment</code>s.  Each node in the tree contains a <code>bsphere</code>. All tfrags below the node fit into this sphere.</p><p>The second to last array (if it exists) is a <code>drawable-inline-array-node</code>. This contains an inline array of <code>draw-node</code>. Each <code>draw-node</code> is the parent of between 1 and 8 <code>tfragment</code>s. They store a reference to the first child <code>tfragment</code> and a child count, and the children are just the ones that come after the first <code>tfragment</code> in memory.</p><p>The third to last array (if it exists) is also a <code>drawable-inline-array-node</code>, containing an inline array of <code>draw-node</code>. Each <code>draw-node</code> is the parent of between 1 and 8 <code>draw-node</code>s from the array mentioned above.  They store a reference to the first child <code>draw-node</code> and a child count, and the children are stored consecutively.</p><p>This pattern continues until you get a <code>drawable-inline-array-node</code> with 8 or fewer nodes at the top.</p><p>All the <code>draw-node</code> and <code>tfragment</code>s have ID numbers. These are used for the occlusion culling system. The visibility numbering is shared with all the other <code>drawable-tree</code>s in the <code>bsp-header</code>. The indices are given out consecutively, starting from the roots. Between depths, they are aligned to 32 elements, so there are some unused ids.  These IDs are the index of the bit in the visibility string.</p><p>With that out of the way, we can now go through the tfrag renderer</p><h1>Tfrag</h1><p>The rough process for rendering is:</p><ul><li>&quot;login&quot; the data</li><li>do &quot;drawing&quot; as part of the <code>drawable</code> system (on EE)</li><li>do the real &quot;draw&quot;</li><li>do culling</li><li>compute time of day colors (or other precomputation)</li><li>generate DMA lists</li><li>unpack data to VU memory</li><li>transform vertices</li><li>clip</li><li>build gs packets</li><li>XGKICK</li></ul><p>I expect that most other renderers will be pretty similar.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="login">Login<a class="hash-link" href="#login" title="Direct link to heading">​</a></h2><p>The tfrag data needs to be initialized before it can be used. You only have to do this once. This is called <code>login</code>, and it&#x27;s a method of all <code>drawable</code>s. The level loader will call the <code>login</code> method of many things as part of the level load.  For <code>tfrag</code>, all I had to do was decompile the <code>login</code> methods, and it worked and I could completely ignore this until tfrag3.</p><p>It&#x27;s possible to just call <code>login</code> on an entire level, but this probably takes too long, so the level loader will cleverly split it up over multiple frames.</p><p>It is from:</p><ul><li><code>level-update</code></li><li><code>load-continue</code></li><li><code>level-update-after-load</code></li><li>various calls to <code>login</code>.</li></ul><p>In the end, the only thing the <code>login</code> does for tfrag is:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(adgif-shader-login-no-remap (-&gt; obj shader i))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>for all the &quot;shaders&quot; in all the tfrags.  A &quot;shader&quot; is an <code>adgif-shader</code>, which is just some settings for the GS that tells it drawing modes, like which texture to use, blending modes, etc. The <code>tfrag</code> VU1 code will send these to the GIF as needed when drawing. A <code>tfragment</code> can have multiple shaders. There is a different shader per texture.</p><p>The actual &quot;shader&quot; object is just 5x quadwords that contain &quot;adress + data&quot; format data. The address tells the GIF which parameter to change and the &quot;data&quot; has the value of the parameter. Some of them are not set properly in the level data, and the <code>adgif-shader-login-no-remap</code> function updates them. For tfrag, the 5 addresses are always the same:</p><ul><li><code>TEST_1</code>: this sets the alpha and z test settings. This is set properly in the level data and <code>login</code> doesn&#x27;t touch it.</li><li><code>TEX0_1</code>: this has some texture parameters. This is 0 in the level data and is modified by <code>login</code>.</li><li><code>TEX1_1</code>: this has more texture parameters. In the level data this is has <code>0x120</code> as the value and the address is set to the texture ID of the texture. During <code>login</code>, the texture ID is looked up in the texture pool and <code>TEX0_1</code>/<code>TEX1_1</code> are set to point to the right VRAM address and have the right settings to use the texture.</li><li><code>MIPTBP1_1</code>: is mipmap settings. I ignore these because we do our own mipmapping.</li><li><code>CLAMP_1</code>: this has texture clamp settings. This is set properly in the level data.</li><li><code>ALPHA_1</code>: this has alpha blend settings. This is set properly in the level data.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="calling-the-draw-method">Calling the <code>draw</code> method<a class="hash-link" href="#calling-the-draw-method" title="Direct link to heading">​</a></h2><p>The <code>tfragment</code> at least pretends to use the <code>drawable</code> system, and the drawing is initiated by calling <code>draw</code> on the <code>drawable-tree-tfrag</code>. Getting this to actually be called took some digging - it uses some functions in later files that we haven&#x27;t completed yet.</p><p>When the level is loaded, the <code>bsp-header</code> is added to the <code>*background-draw-engine*</code> by the level loader. The path to calling draw is:</p><ul><li>In <code>main.gc</code>, there is a <code>display-loop</code>. This has a while loop that runs once per frame and runs many systems.</li><li>The <code>display-loop</code> calls <code>*draw-hook*</code></li><li>The <code>*draw-hook*</code> variable is set to <code>main-draw-hook</code></li><li>The <code>main-draw-hook</code> calls <code>real-main-draw-hook</code></li><li>The <code>real-main-draw-hook</code> calls <code>(execute-connections *background-draw-engine*</code></li><li>This &quot;engine&quot; calls the <code>add-bsp-drawable</code> function on the <code>bsp-header</code> for each loaded level.</li><li>The <code>draw</code> method of <code>bsp-header</code> sets up some stuff on the scratchpad and some <code>vf</code> registers.</li><li>The <code>draw</code> method of <code>bsp-header</code> calls <code>draw</code> on the <code>drawable-tree-array</code> (defined in parent class <code>drawable-group</code>)</li><li>The <code>draw</code> method of <code>drawable-group</code> checks if the level is visible, and if so calls <code>draw</code> on each tree.</li><li>The <code>draw</code> method of <code>drawable-tree-tfrag</code> simply adds the tree to a list of trees in <code>*background-work*</code>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="real-drawing">Real &quot;drawing&quot;<a class="hash-link" href="#real-drawing" title="Direct link to heading">​</a></h2><p>Later on, in the <code>real-main-draw-hook</code>, there is a call to <code>finish-background</code>.</p><p>There&#x27;s some stuff at the top of this function that&#x27;s only used for the separate shrubbery renderer. It sets up some VU0 programs. I noticed that the stuff before tfrag drawing would overwrite this VU0 stuff so I ignored it for now.</p><p>The first thing that happens before any tfrag drawing is setting the <code>vf</code> registers to store the <code>math-camera</code> values. In OpenGOAL, the <code>vf</code> registers aren&#x27;t saved between functions, so I had to manually use the <code>with-vf</code> macro with the <code>:rw &#x27;write</code> flag to save these:</p><div class="language-lisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">v1-48</span><span class="token plain"> *math-camera*</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">with-vf</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">vf16</span><span class="token plain"> vf17 vf18 vf19 vf20 vf21 vf22 vf23 vf24 vf25 vf26 vf27 vf28 vf29 vf30 vf31</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 </span><span class="token lisp-property property">:rw</span><span class="token plain"> </span><span class="token quoted-symbol variable symbol" style="color:rgb(248, 248, 242);font-style:italic">&#x27;write</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">.lvf vf16 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">&amp;-&gt; v1-48 plane </span><span class="token number">0</span><span class="token plain"> quad</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">.lvf vf17 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">&amp;-&gt; v1-48 plane </span><span class="token number">1</span><span class="token plain"> quad</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 </span><span class="token comment" style="color:rgb(98, 114, 164)">;; ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>these will later be used in part of the drawing function. The <code>:rw &#x27;write</code> flag will save these to a structure where we can read them later.</p><p>Then, for each tree:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(upload-vis-bits s1-0 gp-1 a2-4)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>this uploads the visibility data to the scratchpad. The visibility data is stored at the end of the 16 kB scratchpad. The drawable with ID of <code>n</code> can look at the <code>n</code>-th bit of this data to determine if it is visible.  The visibility IDs are per level, and the drawing order of the <code>tfrag</code> will alternate between levels, so they upload this for each tree to draw.  It seems like you could skip this after the first upload if you detect that you&#x27;re drawing multiple trees in the same level.  They do it for TIE and not TFRAG and don&#x27;t know why. The visibility data is based on the position of the camera. Currently this doesn&#x27;t work so I modified it to upload all 1&#x27;s.</p><p>The modification to the code to use the scratchpad in OpenGOAL is:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ;;(spad-vis (the-as (pointer uint128) (+ #x38b0 #x70000000)))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  (spad-vis (scratchpad-ptr uint128 :offset VISIBLE_LIST_SCRATCHPAD))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>0x38b0</code> offset is just something we&#x27;ve noticed over time as being the location of the visible list, so there&#x27;s a constant I made for it. (TODO: I think it&#x27;s also <code>terrain-context work background vis-list</code>)</p><p>The hack for visibility is:</p><div class="language-lisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">;; TODO this is a hack.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">quad-copy!</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">-&gt;</span><span class="token plain"> arg0 vis-bits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">-&gt;</span><span class="token plain"> arg2 all-visible-list</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">+</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">-&gt;</span><span class="token plain"> arg2 visible-list-length</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token number">15</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token number">16</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>which actually modifies the level to say that everything is visbile. The <code>all-visible-list</code> is just a list which has <code>1</code> for every drawable that actually exists (I think, need to configm). There are some skipped ID&#x27;s.</p><p>The next part of drawing is:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  (when (not (or (zero? s0-0) (= s4-1 s0-0)))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    (flush-cache 0)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    (time-of-day-interp-colors-scratch (scratchpad-ptr rgba :offset 6160) s0-0 (-&gt; s1-0 mood))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ;; remember the previous colors</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    (set! s4-1 s0-0)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>where <code>s0-0</code> is the <code>time-of-day-pal</code> for the tfrag tree. It will skip interpolation if it is the same color palette that was just interpolated.</p><p>The <code>time-of-day-interp-colors-scratch</code> function uploads the colors from <code>s0-0</code> to the scratchpad at offset <code>6160</code>. It computes the correct colors for the time-of-day/lighting settings in the the level <code>s1-0</code>&#x27;s mood.  This function is pretty complicated, so I used MIPS2C.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="time-of-day-interp-colors-scratch">Time of Day Interp Colors Scratch<a class="hash-link" href="#time-of-day-interp-colors-scratch" title="Direct link to heading">​</a></h3><p>The very first attempts for TFRAG just skipped this function because it wasn&#x27;t needed to debug the basic drawing functions. I manually set the lighting to <code>0.5</code> for all colors and <code>1.0</code> for alpha. I suspected that this stored the colors in the scratchpad. I assumed it would be fine if these garbage for a first test.</p><p>I noticed that this function does a few tricky things. It uses the scratchpad and it uses DMA.  I know it uses DMA because I saw:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">lui</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">4096</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                                 </span><span class="token comment" style="color:rgb(98, 114, 164)">// lui t0, 4096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// some stuff in between...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">ori</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">a1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> t0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">54272</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                            </span><span class="token comment" style="color:rgb(98, 114, 164)">// ori a1, t0, 54272 = (0x1000D400) SPR TO</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and this <code>0x1000D4000</code> is the address of the DMA control register for transferring to the scratchpad.  The scratchpad here is just used as a faster memory. And eventually the draw code will read the result from the scratchpad.</p><p>They really like this pattern of doing work on the scratchpad while DMA is running in the background, copying things to/from the scratchpad. In this case, they upload the palette to the scratchpad in chunks. As those uploads are running, they do math on the previous upload to blend together the colors for the chosen time of day.  To get optimal performance, they often count how many times they finish before the DMA is ready. When this happens, they increment a &quot;wait&quot; variable.</p><p>I modified scratchpad access like this:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">lui</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">28672</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                                </span><span class="token comment" style="color:rgb(98, 114, 164)">// lui v1, 28672      0x7000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// stuff in between skipped...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">//c-&gt;ori(v1, v1, 2064);                           // ori v1, v1, 2064 SPAD mods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">get_fake_spad_addr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fake_scratchpad_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">2064</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>the original code would set the address to an offset of 2064 in the scratchpad.</p><p>The first thing they do is wait for any in-progress DMA transfers to finish:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  block_1</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">lw</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> a1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                                 </span><span class="token comment" style="color:rgb(98, 114, 164)">// lw t5, 0(a1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// nop                                            // sll r0, r0, 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// nop                                            // sll r0, r0, 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// nop                                            // sll r0, r0, 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">andi</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> t5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">256</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                             </span><span class="token comment" style="color:rgb(98, 114, 164)">// andi t5, t5, 256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// nop                                            // sll r0, r0, 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  bc </span><span class="token operator">=</span><span class="token plain"> c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">sgpr64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                          </span><span class="token comment" style="color:rgb(98, 114, 164)">// bne t5, r0, L62</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// nop                                            // sll r0, r0, 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">bc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">goto</span><span class="token plain"> block_1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">                           </span><span class="token comment" style="color:rgb(98, 114, 164)">// branch non-likely</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>which is reading and checking the DMA register in a loop. We can just get rid of this - we make all DMA instant.</p><p>I also modified the code that starts the transfer to just do a memcpy from the fake scratchpad. See the EE manual for details on what these registers mean. The <code>a1</code> register points to the control register for SPR TO DMA.</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// c-&gt;sw(t4, 16, a1);                                // sw t4, 16(a1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    u32 madr </span><span class="token operator">=</span><span class="token plain"> c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">sgpr64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">daddiu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> t3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">32</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                           </span><span class="token comment" style="color:rgb(98, 114, 164)">// daddiu t3, t3, -32</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// c-&gt;sw(v1, 128, a1);                               // sw v1, 128(a1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    u32 sadr </span><span class="token operator">=</span><span class="token plain"> c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">sgpr64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">addiu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                             </span><span class="token comment" style="color:rgb(98, 114, 164)">// addiu t5, r0, 64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">//c-&gt;sw(t5, 32, a1);                                // sw t5, 32(a1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    u32 qwc </span><span class="token operator">=</span><span class="token plain"> c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">sgpr64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">addiu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">256</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                            </span><span class="token comment" style="color:rgb(98, 114, 164)">// addiu t5, r0, 256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// c-&gt;sw(t5, 0, a1);                                 // sw t5, 0(a1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">spad_to_dma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fake_scratchpad_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> madr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> sadr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> qwc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    c</span><span class="token operator">-&gt;</span><span class="token function" style="color:rgb(80, 250, 123)">daddiu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> t4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1024</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                          </span><span class="token comment" style="color:rgb(98, 114, 164)">// daddiu t4, t4, 1024</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This data is double buffered. One buffer is being filled from DMA while another is being processed. To swap buffers, they often use <code>xor</code> to toggle a bit. But this trick only works if our buffer has the same alignment as theirs up to the bit being toggled (otherwise their first <code>xor</code> might toggle a 0 to a 1, advancing the address, where ours does the opposite).</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">c-&gt;xori(v1, v1, 1024);                            // xori v1, v1, 1024</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The actual processing is an annoying pipelined loop. The palette stores groups of 8 colors. The time of day system computes 8 weights, passed to this function. Each of the 8 colors is multiplied by the weight and added. This process is repeated for each group. There are usually 1024 or 2048 groups.  The tfragments are lit by indexing into these groups.  One important detail is that the r/g/b/a values are saturated so they don&#x27;t overflow.</p><p>This part works using the MIPS2C function in the first tfrag renderers. In the third one, it was annoying to get this data to the C++ renderer, so I just recomputed it in C++. This also lets us manually override the time of day values for fun. The code is much simpler:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="token plain"> </span><span class="token class-name">Tfrag3</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">interp_time_of_day_slow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">float</span><span class="token plain"> weights</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                     </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">vector</span><span class="token operator">&lt;</span><span class="token plain">tfrag3</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">TimeOfDayColor</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token plain"> in</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                     math</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">Vector</span><span class="token operator">&lt;</span><span class="token plain">u8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">4</span><span class="token operator">&gt;</span><span class="token operator">*</span><span class="token plain"> out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">size_t color </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> color </span><span class="token operator">&lt;</span><span class="token plain"> in</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> color</span><span class="token operator">++</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    math</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">Vector4f result </span><span class="token operator">=</span><span class="token plain"> math</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Vector4f</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">zero</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">int</span><span class="token plain"> component </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> component </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> component</span><span class="token operator">++</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      result </span><span class="token operator">+=</span><span class="token plain"> in</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rgba</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">component</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token generic-function function" style="color:rgb(80, 250, 123)">cast</span><span class="token generic-function generic class-name operator">&lt;</span><span class="token generic-function generic class-name keyword" style="color:rgb(189, 147, 249);font-style:italic">float</span><span class="token generic-function generic class-name operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> weights</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">component</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">255.f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">255.f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">255.f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">128.f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// note: different for alpha!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token generic-function function" style="color:rgb(80, 250, 123)">cast</span><span class="token generic-function generic class-name operator">&lt;</span><span class="token generic-function generic class-name">u8</span><span class="token generic-function generic class-name operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-call-to-draw">The Call to Draw<a class="hash-link" href="#the-call-to-draw" title="Direct link to heading">​</a></h3><p>There was another scratchpad use to patch up here. They often treat the scratchpad as a <code>terrain-context</code>. There are quite a few overlays here so sometimes you have to do some manual searching to figure it out.</p><div class="language-lisp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lisp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">set!</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">scratchpad-object</span><span class="token plain"> terrain-context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> bsp lev-index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">-&gt;</span><span class="token plain"> s1-0 index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">set!</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">-&gt;</span><span class="token plain"> *tfrag-work* min-dist z</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token number">4095996000.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">;; draw!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">draw-drawable-tree-tfrag</span><span class="token plain"> s2-0 s1-0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">;; remember closest.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">set!</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">-&gt;</span><span class="token plain"> *level* level </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">scratchpad-object</span><span class="token plain"> terrain-context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> bsp lev-index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> closest-object </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token car">-&gt;</span><span class="token plain"> *tfrag-work* min-dist z</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>the remembering closest is used for figuring out which mip levels of texture need uploading.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="draw-node-culling">Draw node culling<a class="hash-link" href="#draw-node-culling" title="Direct link to heading">​</a></h3><p>This is a part that I left out. I still haven&#x27;t done it. But I suspect it looks at the position of the camera (stored in <code>vf</code> regs from earlier) and modifies the visibility data. I think it uses a &quot;sphere in view frustum&quot; check and traverses the tree of <code>draw-node</code>s. I think it only culls the <code>draw-node</code>s and not actually the <code>tfragment</code>s, and it modifies the visibility data in place.  It only culls the range of nodes that correspond to the tree we&#x27;re drawing.</p><p>Later, on tfrag3, I did the culling in C++. (More on this later - it&#x27;s done in a tricky way so that you can efficiently build a list of only the visible things to send to the GPU).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dma-list-generation">DMA List Generation<a class="hash-link" href="#dma-list-generation" title="Direct link to heading">​</a></h3><p>The objective of the draw function is to generate a DMA list. This gets added to the entire DMA list for the frame and gets sent to the VIF. The DMA data is a list of instructions like:</p><ul><li>upload this data to the VU memory</li><li>run this VU program</li><li>change various settings related to the VU data upload.</li></ul><p>The pattern used by tfrag is:</p><ul><li>Call <code>tfrag-init-buffer</code> once. This is unoptimized code that just sets things up.</li><li>Call <code>draw-inline-array-tfrag</code>. This adds DMA per tfragment. It is super optimized.</li><li>Call <code>tfrag-end-buffer</code>. This is unoptimized code that ends the DMA list for tfrag</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/open-goal/open-goal.github.io/tree/master/documentation/port-info/porting_tfrag.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/port-info/tfrag"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Basic Process for Drawing</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#dma" class="table-of-contents__link toc-highlight">DMA</a></li><li><a href="#the-vif" class="table-of-contents__link toc-highlight">The VIF</a></li><li><a href="#vu-programs" class="table-of-contents__link toc-highlight">VU programs</a></li><li><a href="#vu-buffer-hell" class="table-of-contents__link toc-highlight">VU buffer hell</a></li><li><a href="#gif" class="table-of-contents__link toc-highlight">GIF</a></li><li><a href="#drawables-for-tfrag" class="table-of-contents__link toc-highlight">Drawables for Tfrag</a></li><li><a href="#login" class="table-of-contents__link toc-highlight">Login</a></li><li><a href="#calling-the-draw-method" class="table-of-contents__link toc-highlight">Calling the <code>draw</code> method</a></li><li><a href="#real-drawing" class="table-of-contents__link toc-highlight">Real &quot;drawing&quot;</a><ul><li><a href="#time-of-day-interp-colors-scratch" class="table-of-contents__link toc-highlight">Time of Day Interp Colors Scratch</a></li><li><a href="#the-call-to-draw" class="table-of-contents__link toc-highlight">The Call to Draw</a></li><li><a href="#draw-node-culling" class="table-of-contents__link toc-highlight">Draw node culling</a></li><li><a href="#dma-list-generation" class="table-of-contents__link toc-highlight">DMA List Generation</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 OpenGOAL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b80e7d5d.js"></script>
<script src="/assets/js/main.1d3489b1.js"></script>
</body>
</html>