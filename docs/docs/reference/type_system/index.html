<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-reference/type_system">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/shoelace.js" type="module"></script><title data-rh="true">OpenGOAL&#x27;s Type System | OpenGOAL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://open-goal.github.io/docs/reference/type_system"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="OpenGOAL&#x27;s Type System | OpenGOAL"><meta data-rh="true" name="description" content="This document explains the GOAL type system.  The GOAL type system supports runtime typing, single inheritance, virtual methods, and dynamically sized structures."><meta data-rh="true" property="og:description" content="This document explains the GOAL type system.  The GOAL type system supports runtime typing, single inheritance, virtual methods, and dynamically sized structures."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://open-goal.github.io/docs/reference/type_system"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/reference/type_system" hreflang="en"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/reference/type_system" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.8d1fafd2.css">
<link rel="preload" href="/assets/js/runtime~main.9950f227.js" as="script">
<link rel="preload" href="/assets/js/main.042d6f4a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OpenGOAL</b></a><a class="navbar__item navbar__link" href="/progress">Progress</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/open-goal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">An Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/language-reference">Language Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Language Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/reference/type_system">OpenGOAL&#x27;s Type System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/method_system">OpenGOAL&#x27;s Method System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/syntax">OpenGOAL Syntax &amp; Examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/lib">Standard Library</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/reader">Reader</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/goos">GOOS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/object_file_formats">Object File Formats</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/process_and_state">Process and State</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/decompiler_states">States in the Decompiler</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/usage">Usage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Usage&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/developing">Developing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/pc-port-info">PC Port Info</a><button aria-label="Toggle the collapsible sidebar category &#x27;PC Port Info&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/language-reference"><span itemprop="name">Language Reference</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">OpenGOAL&#x27;s Type System</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>OpenGOAL&#x27;s Type System</h1><p>This document explains the GOAL type system.  The GOAL type system supports runtime typing, single inheritance, virtual methods, and dynamically sized structures.</p><p>There&#x27;s a single type system library, located in <code>common/type_system</code>.  It will be used in both the decompiler and compiler. The plan is to have a single <code>all_types.gc</code> file which contains all type information (type definitions and types of globals). The decompiler will help generate this, but some small details may need to be filled in manually for some types.  Later versions of the decompiler can use this information to figure out what fields of types are being accessed.  We can also add a test to make sure that types defined in the decompiled game match <code>all_types.gc</code>.</p><p>The main features are:</p><ul><li><code>TypeSystem</code> stores all type information and provides a convenient way to add new types or request information about existing types.</li><li><code>Type</code> information about a GOAL Type.  A &quot;base GOAL type&quot; is identified by a single unique string. Examples: <code>function</code>, <code>string</code>, <code>vector3h</code>.</li><li><code>TypeSpec</code> a way to specify either <code>Type</code> or a &quot;compound type&quot;.  Compound types are used to create types which represent specific function types (function which takes two integer arguments and returns a string), or specific pointer/array types (pointer to an integer).  These can be represented as (possibly nested) lists, like <code>(pointer integer)</code> or <code>(function (integer integer) string)</code>.</li><li>Type Checking for compiler</li><li>Parsing of type definitions for compiler</li><li>Lowest common ancestor implementation for compiler to figure out return types for branching forms.</li><li>Logic to catch multiple incompatible type definitions for both compiler warnings and decompiler sanity checks</li></ul><p>The type system will store:</p><ul><li>The types of all global variables (this includes functions)</li><li>Information about all types:<ul><li>Fields/specific details on how to load from memory, alignment, sign extension, size in arrays, etc...</li><li>Parent type</li><li>Methods not defined for the parent.</li></ul></li></ul><p>It&#x27;s important that all of the type-related info is stored/calculated in a single location. The proof of concept compiler did not have the equivalent of <code>TypeSystem</code> and scattered field/array access logic all over the place.  This was extremely confusing to get right.</p><p>If type information is specified multiple times, and is also inconsistent, the TypeSystem can be configured to either throw an exception or print a warning.</p><p>This will be a big improvement over the &quot;proof of concept&quot; compiler which did not handle this situation well.  When debugging GOAL you will often put the same file through the compiler again and again, changing functions, but not types.  In this case, there should be no warnings. If the type does change, it should warn (as old code may exist that uses the old type layout), but shouldn&#x27;t cause the compiler to abort, error, or do something very unexpected.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="compile-time-vs-run-time">Compile-time vs Run-time<a class="hash-link" href="#compile-time-vs-run-time" title="Direct link to heading">​</a></h2><p>The types in the runtime are only a subset of the compile time types. Here are the rules I&#x27;ve discovered so far</p><ul><li>Any compound types become just the first type. So <code>(pointer my-type)</code> becomes <code>pointer</code>.</li><li>The <code>inline-array</code> class just becomes <code>pointer</code>.</li><li>Some children of integers disappear, but others don&#x27;t. The rules for this aren&#x27;t known yet.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="types-of-types">Types of Types<a class="hash-link" href="#types-of-types" title="Direct link to heading">​</a></h2><p>Everything in GOAL has a type at compile time.  A subset of compile-time types are also available in the runtime as objects with the same name as the type.  For example, there is a <code>string</code> type, and at runtime there is a global object named <code>string</code> which is an object of type <code>type</code> containing information about the <code>string</code> type.</p><p>Some objects have runtime type information, and others don&#x27;t.  Objects which have runtime type information can have their type identified at runtime, and are called &quot;boxed objects&quot;.  Objects without runtime type information are called &quot;unboxed objects&quot;.  An unboxed object cannot reliably be detected as a unboxed object - you can&#x27;t write a function that takes an arbitrary object and tells you if its boxed or not.  However, boxed objects can always be recognized as boxed.</p><p>All types have a parent type, and all types descend from the parent type <code>object</code>, except for the special type <code>none</code> (and maybe <code>_type_</code>, but more on this later). The <code>none</code> type doesn&#x27;t exist in the runtime and is used to represent an invalid value that the compiler should not use.  For example, the return type of a function which doesn&#x27;t return anything is <code>none</code>, and attempting to use this value should cause an error.</p><p>Here are some important special types:</p><ul><li><code>object</code> - the parent of all types</li><li><code>structure</code> - parent type of any type with fields</li><li><code>basic</code> - parent type of any <code>structure</code> with runtime type information.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="value-types">Value Types<a class="hash-link" href="#value-types" title="Direct link to heading">​</a></h3><p>Some GOAL types are &quot;value types&quot;, meaning they are passed by value when used as arguments to functions, return values from functions, local variables, and when using <code>set!</code>.  These are always very small and fit directly into the CPU registers.  Some example value types:</p><ul><li>Floating point numbers</li><li>Integers</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reference-types">Reference Types<a class="hash-link" href="#reference-types" title="Direct link to heading">​</a></h3><p>Other GOAL types are &quot;reference types&quot;, meaning they act like a reference to data when used as arguments to functions, return values from functions, local variables, and when using <code>set!</code>.  The data can be allocated on a heap, on the stack, or as part of static data included when loading code (which is technically also on a heap).  All structure/basic types are reference types.</p><p>You can think of these like C/C++ pointers or references, which is how it is implemented.  The difference is that there&#x27;s no special notation for this.  A GOAL <code>string</code> object is like a C/C++ <code>string*</code> or <code>string&amp;</code>.  A GOAL &quot;pointer to reference type&quot; is like a C/C++ <code>my_type**</code>.</p><p>Note - this is quite a bit different from C/C++. In C++ you can have a structure with value semantics (normal), or reference semantics (C++ reference or pointer).  In GOAL, there is no value semantics for structures!  This is great because it means function arguments/variables always fit into registers.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-size-types">Dynamic Size Types<a class="hash-link" href="#dynamic-size-types" title="Direct link to heading">​</a></h3><p>Any type which ends with a dynamic array as the last field is dynamic. For these, it&#x27;s a good idea to implement the <code>asize-of</code> method.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compound-types">Compound Types<a class="hash-link" href="#compound-types" title="Direct link to heading">​</a></h3><p>A compound type is a type like &quot;a pointer to an int64&quot; or &quot;a function which takes int as an argument and returns a string&quot;. These exist only at compile time, and get simplified at runtime. For example, all pointers become <code>pointer</code> and all functions become <code>function</code>. (The one exception to this seems to be <code>inline-array-class</code> stuff, but this is not yet supported in OpenGOAL).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pointer">Pointer<a class="hash-link" href="#pointer" title="Direct link to heading">​</a></h4><p>Pointers work like you would expect. They can only point to memory types - you can&#x27;t have a <code>(pointer int)</code>, instead you must have a <code>(pointer int32)</code> (for example).  Note that a <code>(pointer basic)</code> is like a C++ <code>basic**</code> as <code>basic</code> is already like a C++ pointer to struct. You can nest these, like <code>(pointer (pointer int64))</code>.  If you want a pointer with no type, (like C++ <code>void*</code>) just use a plain <code>pointer</code>. The <code>(pointer none)</code> type is invalid.</p><p>Like in C/C++, you can use array indexing with a pointer. One thing to note is that a <code>(pointer basic)</code> (or pointer to any reference type) is like a C++ &quot;array of pointers to structs&quot;. To get the C++ &quot;array of structs&quot;, you need an <code>inline-array</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="arrays">Arrays<a class="hash-link" href="#arrays" title="Direct link to heading">​</a></h4><p>For value types, arrays work as you expect.  They have type <code>(pointer your-type)</code>.  Arrays of references come in two versions:</p><ul><li>Array of references: <code>(pointer your-type)</code>, like a C array of pointers</li><li>Array of inline objects: <code>(inline-array your-type)</code>, like a C array of structs</li></ul><p>The default alignment of structs is 16 bytes, which is also the minimum alignment of <code>kmalloc</code>, and the minimum alignment used when using a reference type as an inline field.  However, it&#x27;s possible to violate this rule in a <code>(inline-array your-type)</code> to be more efficient.  The <code>your-type</code> can set a flag indicating it should be packed in an inline array.</p><p>I believe the alignment then becomes the maximum of the minimum alignment of the <code>your-type</code> fields.  So if you have a type with two <code>uint32</code>s (alignment 4 bytes), an <code>(inline-array your-type)</code> can then have spacing of 8 bytes, instead of the usual minimum 16.  The behavior of a <code>(field-name your-type :inline #t)</code> is unchanged and will still align at the minimum of 16 bytes. I <em>believe</em> that the first element of the array will still have an alignment of 16.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="inline-arrays">Inline Arrays<a class="hash-link" href="#inline-arrays" title="Direct link to heading">​</a></h5><p>These are only valid for reference types. They refer to an array of the actual data (like C array of structs) rather than an array of reference (like C array of pointers to structs, or GOAL <code>(pointer structure)</code>).  At runtime, <code>inline-array</code> becomes pointer.</p><p>For an inline array of basics, elements are 16-byte aligned. For <code>structure</code>s that aren&#x27;t <code>basic</code>, the alignment is usually the minimum alignment of all members of the structure, but there is an option to make it 16-byte aligned if needed.</p><p>For information about how to create these arrays, see <code>deftype</code> (fields in a type) and <code>new</code> (create just an array) sections.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="function">Function<a class="hash-link" href="#function" title="Direct link to heading">​</a></h4><p>Function compound types look like this <code>(function arg0-type arg1-type... return-type)</code>. There can be no arguments. The <code>return-type</code> must always be specified, and should be <code>none</code> if there is no return value.  The argument types themselves can be compound types.  In order to call a function, you must have a compound function type - a <code>function</code> by itself cannot be called.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="field-definitions">Field Definitions<a class="hash-link" href="#field-definitions" title="Direct link to heading">​</a></h3><p>GOAL field definitions look like this:</p><p><code>(name type-name [optional stuff])</code></p><p>where optional stuff can include these, in any order:</p><ul><li><code>:inline #t</code> (default is false), to mark field as inline. This can only be done for a reference type, and indicates that the data should be stored inline, in the type, rather than just storing a reference to data stored elsewhere.</li><li><code>:dynamic #t</code> (default is false), to mark field as dynamically-sized array (must be the last field in the type)</li><li>a number, to give an array size.</li><li><code>:offset x</code> where x is a number, to manually specify where the field is located</li></ul><p>There are many combinations of reference/value, dynamic/not-dynamic, inline/not-inline, array-size/no-array-size, and it can be confusing.  This list explains all that are valid.</p><ul><li>Value type, no modifiers: a single value is stored in the field. The field type is the value type.</li><li>Value type, <code>:dynamic #t</code>: the field marks the beginning of an array (of unknown size). Field type is <code>(pointer your-type)</code></li><li>Value type, with array size: the field marks the beginning of an array (of known size). Field type is <code>(pointer your-type)</code></li><li>Value type, with <code>:inline #t</code>: invalid in all cases.</li><li>Reference type, no modifiers: a single reference is stored in the type. Type of field is <code>your-type</code> (a C++ pointer).</li><li>Reference type, <code>:inline #t</code>: a single object is stored inside the type. Type of field is <code>your-type</code> still (a C++ pointer). The access logic is different to make this work.</li><li>Reference type, <code>:dynamic #t</code> or array size: the field marks the beginning of an <strong>array of references</strong>. Field type is <code>(pointer your-type)</code>.  Like C array of pointers.</li><li>Reference type, <code>:inline #t</code> and (<code>:dynamic #t</code> or array size): the field marks the beginning of an <strong>array of inline objects</strong>. Field type is <code>(inline-array your-type)</code>. Like C array of structs.</li></ul><p>Bonus ones, for where the array is stored <em>outside</em> of the type:</p><ul><li>A dynamically typed GOAL array, stored outside your type (think <code>std::vector</code>): use <code>(name (array your-type))</code></li><li>A dynamically typed GOAL array, stored inside your type: Not allowed, <code>array</code> is dynamic!</li><li>An array of value types, stored outside your type: use <code>(name (pointer your-type))</code></li><li>An array of references (C++ array of pointers), stored outside your type: use <code>(name (pointer your-ref-type))</code></li><li>An array of objects of reference type (C++ array of structs), stored outside your type: use <code>(name (inline-array your-ref-type))</code></li></ul><p>Of course, you can combine these, to get even more confusing types! But this seems uncommon.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="field-placement">Field Placement<a class="hash-link" href="#field-placement" title="Direct link to heading">​</a></h4><p>The exact rules for placing fields in GOAL types is unknown, but the simple approach of &quot;place the next field as close as possible to the end of the last field&quot; seems to get it right almost all the time. However, we need to be extra certain that we lay out type fields correctly because many GOAL types have overlapping fields.</p><p>The theory I&#x27;m going with for now is:</p><ul><li>The order of fields in the <code>inspect</code> method is the order fields are listed in in the type definition</li><li>In the rare cases this is wrong, this is due to somebody manually specifying an offset.</li></ul><p>As a result, we should specify offsets like this:</p><ul><li>If we think a field was manually placed, use <code>:offset</code> to override. This is certain to be right</li><li>If we think a field was automatically placed, use <code>:offset-assert</code> to inform the compiler where we expect it to be.  In this case it will still place the field automatically, but if the result is different from the <code>:offset-assert</code>, it will throw an error.</li><li>Avoid defining any fields without <code>:offset</code> or <code>:offset-assert</code></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="built-in-types">Built-in Types<a class="hash-link" href="#built-in-types" title="Direct link to heading">​</a></h2><p>There are a number of built-in types. I use &quot;abstract&quot; type to refer to a type that is only a parent type.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="none"><code>none</code><a class="hash-link" href="#none" title="Direct link to heading">​</a></h3><p>This is a special type that represents &quot;no information&quot;. This is the return type of a function which returns nothing, and also the return type of an expression that doesn&#x27;t return anything.  For example, the expression <code>(goto x)</code> does not produce a value, so its type is <code>none</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="object"><code>object</code><a class="hash-link" href="#object" title="Direct link to heading">​</a></h3><p>This is the parent type of all types. This is an abstract class. In a variable, this is always <code>object</code>, and can hold any <code>object</code>. In memory, this is either <code>object32</code> or <code>object64</code>. The <code>object32</code> can hold everything except for <code>binteger</code> and 64-bit integers. This type is neither boxed nor unboxed and is neither value nor reference.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="structure-child-of-object"><code>structure</code> (child of <code>object</code>)<a class="hash-link" href="#structure-child-of-object" title="Direct link to heading">​</a></h3><p>This is the parent type of all types with fields. This is an abstract class and a reference class.  A <code>structure</code> can hold any <code>structure</code>, both in memory and in a variable.  It is unboxed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="basic-child-of-structure"><code>basic</code> (child of <code>structure</code>)<a class="hash-link" href="#basic-child-of-structure" title="Direct link to heading">​</a></h3><p>This is the &quot;boxed&quot; version of <code>structure</code>. The first field of a basic is <code>type</code>, which contains the <code>type</code> of the object. It is boxed and a reference. A <code>basic</code> can hold any <code>basic</code>, both in memory and in a variable.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="symbol-child-of-basic"><code>symbol</code> (child of <code>basic</code>)<a class="hash-link" href="#symbol-child-of-basic" title="Direct link to heading">​</a></h3><p>A symbol has a name and a value. The name is a string, and the value is an <code>object32</code>.  Note that the value is an <code>object32</code> so you cannot store a 64-bit integer in a symbol.  It is considered &quot;bad&quot; to store unboxed objects in symbols, though you can get away with it sometimes.</p><p>All <code>symbol</code>s are stored in the global symbol table, which is a hash table. As a result, you cannot have multiple symbols with the same name. A name is enough to uniquely determine the symbol.  To get a symbol, use the syntax <code>&#x27;symbol-name</code>. To get the value, use <code>symbol-name</code>.</p><p>Each global variable, type, and named global function has a symbol for it which has the variable, type, or function as its value. The linker is able to perform symbol table lookups at link time and patch the code so you don&#x27;t have to do a hash table lookup every time you access a global variable, function, or type.</p><p>You can also use symbols as a efficient way to represent a enum. For example, a function may return <code>&#x27;error</code> or <code>&#x27;complete</code> as a status. The compiler is able to compare symbols for equality very efficiently (just a pointer comparison, as symbols are a reference type).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="type-child-of-basic"><code>type</code> (child of <code>basic</code>)<a class="hash-link" href="#type-child-of-basic" title="Direct link to heading">​</a></h3><p>A <code>type</code> stores information about an OpenGOAL type, including its size, parent, and name (stored as a <code>symbol</code>). It also stores the method table.  Some OpenGOAL types (children of integers, bitfield types, enums, compounds types) do not have runtime types, and instead become the parent/base type. But these types cannot have runtime type information or methods and are pretty rare.  It is a reference type, is boxed, and is dynamically sized (the method table&#x27;s size is not fixed).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="string-child-of-basic"><code>string</code> (child of <code>basic</code>)<a class="hash-link" href="#string-child-of-basic" title="Direct link to heading">​</a></h3><p>A string. The string is null terminated and also stores the buffer size. This type is a reference type, is boxed, and is also dynamically sized.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="function-child-of-basic"><code>function</code> (child of <code>basic</code>)<a class="hash-link" href="#function-child-of-basic" title="Direct link to heading">​</a></h3><p>A function. Boxed and reference. It is a reference to a function, so it&#x27;s like a C/C++ function pointer type.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kheap-child-of-structure"><code>kheap</code> (child of <code>structure</code>)<a class="hash-link" href="#kheap-child-of-structure" title="Direct link to heading">​</a></h3><p>A simple bump-allocated heap. Doesn&#x27;t store the heap memory, just metadata. Supports allocating from either the top or the bottom. This is used as the memory allocation strategy for the global, debug, and level heaps. Unboxed, reference, not dynamic.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="array-child-of-basic"><code>array</code> (child of <code>basic</code>)<a class="hash-link" href="#array-child-of-basic" title="Direct link to heading">​</a></h3><p>A &quot;fancy&quot; array. It is not yet implemented in OpenGOAL.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pair-child-of-object"><code>pair</code> (child of <code>object</code>)<a class="hash-link" href="#pair-child-of-object" title="Direct link to heading">​</a></h3><p>A pair. It is boxed. You should not make child types of <code>pair</code>.  The two objects stored by the pair are <code>object32</code>s.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pointer-child-of-object"><code>pointer</code> (child of <code>object</code>)<a class="hash-link" href="#pointer-child-of-object" title="Direct link to heading">​</a></h3><p>It is a 32-bit value type containing a pointer. Not boxed, value type. See section on compound types for more information.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="number-child-of-object"><code>number</code> (child of <code>object</code>)<a class="hash-link" href="#number-child-of-object" title="Direct link to heading">​</a></h3><p>Abstract type for all numbers. Value type. 64-bits.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="float-child-of-number"><code>float</code> (child of <code>number</code>)<a class="hash-link" href="#float-child-of-number" title="Direct link to heading">​</a></h3><p>4-byte, single precision floating point number.  Value type.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="integer-child-of-number"><code>integer</code> (child of <code>number</code>)<a class="hash-link" href="#integer-child-of-number" title="Direct link to heading">​</a></h3><p>Abstract class for integer numbers. Child classes are <code>sinteger</code> (signed integer), <code>uinteger</code> (unsigned integer), and <code>binteger</code> (boxed-integer, always signed).  These are all 64-bit types.</p><p>Children of <code>sinteger</code> and <code>uinteger</code> are <code>int8</code>, <code>int16</code>, <code>int32</code>, <code>int64</code>, <code>uint8</code>, <code>uint16</code>, <code>uint32</code>, <code>uint64</code>.  These are the size you expect, value types, and not boxed. These only exist as memory types. In a variable, there is only <code>int</code> and <code>uint</code>.  These are both 64-bit types. All integer operations (math, logical, shifts) are 64-bit.</p><p>The <code>binteger</code> is a boxed integer. It is a 61 bit signed integer (the other three bits are lost due to the number being boxed). There may actually be a <code>buinteger</code> (or <code>ubinteger</code>) but it doesn&#x27;t exist in OpenGOAL at this point.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="weird-built-in-types-that-arent-supported-yet">Weird Built-in types that aren&#x27;t supported yet.<a class="hash-link" href="#weird-built-in-types-that-arent-supported-yet" title="Direct link to heading">​</a></h4><ul><li><code>vu-function</code></li><li><code>link-block</code></li><li><code>connectable</code></li><li><code>file-stream</code></li><li><code>inline-array</code> (class)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unknown-areas">Unknown Areas<a class="hash-link" href="#unknown-areas" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="inline-array-class">Inline Array Class<a class="hash-link" href="#inline-array-class" title="Direct link to heading">​</a></h3><p>There&#x27;s a weird <code>inline-array-class</code> type that&#x27;s not fully understood yet.  It uses <code>heap-base</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="heap-base">Heap Base<a class="hash-link" href="#heap-base" title="Direct link to heading">​</a></h3><p>This is a field in <code>type</code>. What does it mean?  It&#x27;s zero for most types (at least the early types).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="second-size-field">Second Size Field<a class="hash-link" href="#second-size-field" title="Direct link to heading">​</a></h3><p>There are two fields in <code>type</code> for storing the size. The first one stores the exact size, and by default the second stores the size rounded up to the nearest 16 bytes.  Why? Who uses it? Does it ever get changed?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="todo">TODO<a class="hash-link" href="#todo" title="Direct link to heading">​</a></h2><ul class="contains-task-list containsTaskList_mC6p"><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Kernel types that are built-in</li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Signed/unsigned for a few built-in type fields</li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Tests for field placement logic (probably a full compiler test?)</li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Bitfield types</li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Type redefinition tests (these are a pain and probably useless, might just wait for full compiler tests?)</li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Stuff for decompiler<ul class="contains-task-list containsTaskList_mC6p"><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->What field is here?</li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Export all deftypes</li></ul></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/open-goal/open-goal.github.io/tree/master/documentation/reference/type_system.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/language-reference"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Language Reference</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/reference/method_system"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">OpenGOAL&#x27;s Method System</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#compile-time-vs-run-time" class="table-of-contents__link toc-highlight">Compile-time vs Run-time</a></li><li><a href="#types-of-types" class="table-of-contents__link toc-highlight">Types of Types</a><ul><li><a href="#value-types" class="table-of-contents__link toc-highlight">Value Types</a></li><li><a href="#reference-types" class="table-of-contents__link toc-highlight">Reference Types</a></li><li><a href="#dynamic-size-types" class="table-of-contents__link toc-highlight">Dynamic Size Types</a></li><li><a href="#compound-types" class="table-of-contents__link toc-highlight">Compound Types</a></li><li><a href="#field-definitions" class="table-of-contents__link toc-highlight">Field Definitions</a></li></ul></li><li><a href="#built-in-types" class="table-of-contents__link toc-highlight">Built-in Types</a><ul><li><a href="#none" class="table-of-contents__link toc-highlight"><code>none</code></a></li><li><a href="#object" class="table-of-contents__link toc-highlight"><code>object</code></a></li><li><a href="#structure-child-of-object" class="table-of-contents__link toc-highlight"><code>structure</code> (child of <code>object</code>)</a></li><li><a href="#basic-child-of-structure" class="table-of-contents__link toc-highlight"><code>basic</code> (child of <code>structure</code>)</a></li><li><a href="#symbol-child-of-basic" class="table-of-contents__link toc-highlight"><code>symbol</code> (child of <code>basic</code>)</a></li><li><a href="#type-child-of-basic" class="table-of-contents__link toc-highlight"><code>type</code> (child of <code>basic</code>)</a></li><li><a href="#string-child-of-basic" class="table-of-contents__link toc-highlight"><code>string</code> (child of <code>basic</code>)</a></li><li><a href="#function-child-of-basic" class="table-of-contents__link toc-highlight"><code>function</code> (child of <code>basic</code>)</a></li><li><a href="#kheap-child-of-structure" class="table-of-contents__link toc-highlight"><code>kheap</code> (child of <code>structure</code>)</a></li><li><a href="#array-child-of-basic" class="table-of-contents__link toc-highlight"><code>array</code> (child of <code>basic</code>)</a></li><li><a href="#pair-child-of-object" class="table-of-contents__link toc-highlight"><code>pair</code> (child of <code>object</code>)</a></li><li><a href="#pointer-child-of-object" class="table-of-contents__link toc-highlight"><code>pointer</code> (child of <code>object</code>)</a></li><li><a href="#number-child-of-object" class="table-of-contents__link toc-highlight"><code>number</code> (child of <code>object</code>)</a></li><li><a href="#float-child-of-number" class="table-of-contents__link toc-highlight"><code>float</code> (child of <code>number</code>)</a></li><li><a href="#integer-child-of-number" class="table-of-contents__link toc-highlight"><code>integer</code> (child of <code>number</code>)</a></li></ul></li><li><a href="#unknown-areas" class="table-of-contents__link toc-highlight">Unknown Areas</a><ul><li><a href="#inline-array-class" class="table-of-contents__link toc-highlight">Inline Array Class</a></li><li><a href="#heap-base" class="table-of-contents__link toc-highlight">Heap Base</a></li><li><a href="#second-size-field" class="table-of-contents__link toc-highlight">Second Size Field</a></li></ul></li><li><a href="#todo" class="table-of-contents__link toc-highlight">TODO</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 OpenGOAL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9950f227.js"></script>
<script src="/assets/js/main.042d6f4a.js"></script>
</body>
</html>