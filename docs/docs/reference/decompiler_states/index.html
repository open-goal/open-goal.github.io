<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-reference/decompiler_states">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/shoelace.js" type="module"></script><title data-rh="true">States in the Decompiler | OpenGOAL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://open-goal.github.io/docs/reference/decompiler_states"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="States in the Decompiler | OpenGOAL"><meta data-rh="true" name="description" content="How can I tell if a file has states?"><meta data-rh="true" property="og:description" content="How can I tell if a file has states?"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://open-goal.github.io/docs/reference/decompiler_states"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/reference/decompiler_states" hreflang="en"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/reference/decompiler_states" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.09ceced1.css">
<link rel="preload" href="/assets/js/runtime~main.b80e7d5d.js" as="script">
<link rel="preload" href="/assets/js/main.1d3489b1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OpenGOAL</b></a><a class="navbar__item navbar__link" href="/progress">Progress</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/open-goal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">An Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/language-reference">Language Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Language Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/type_system">OpenGOAL&#x27;s Type System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/method_system">OpenGOAL&#x27;s Method System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/syntax">OpenGOAL Syntax &amp; Examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/lib">Standard Library</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/reader">Reader</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/goos">GOOS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/object_file_formats">Object File Formats</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/process_and_state">Process and State</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/reference/decompiler_states">States in the Decompiler</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/usage">Usage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Usage&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/developing">Developing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/pc-port-info">PC Port Info</a><button aria-label="Toggle the collapsible sidebar category &#x27;PC Port Info&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/language-reference"><span itemprop="name">Language Reference</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">States in the Decompiler</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>States in the Decompiler</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-tell-if-a-file-has-states">How can I tell if a file has states?<a class="hash-link" href="#how-can-i-tell-if-a-file-has-states" title="Direct link to heading">​</a></h2><p>Search in the <code>ir2.asm</code> file for <code>.type state</code>.  If you see something like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    .type state</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">L28:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    .symbol plat-button-move-downward</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    .symbol #f</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    .symbol #f</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    .symbol #f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>that&#x27;s a state, and you can expect the file to have <code>defstate</code>s.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="virtual-vs-non-virtual-states">Virtual vs. Non-Virtual States<a class="hash-link" href="#virtual-vs-non-virtual-states" title="Direct link to heading">​</a></h2><p>A non-virtual state is stored in a global variable with the same name as the state.  This is just like a global function.  You don&#x27;t have to do anything special with this - the decompiler will insert a <code>defstate</code> with the appropriate name and make sure that the name of the symbol and the name stored in the <code>state</code> itself match.</p><p>A virtual state is stored in the method table of a type, similar to a method.  When doing a <code>go</code>, the virtual state will be looked up from the method table of the current process, allowing a child type of process to override the state of its parent.  You can tell if a state is virtual by looking for a call to <code>inherit-state</code> or <code>method-set!</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decompiling-state-handers">Decompiling state handers<a class="hash-link" href="#decompiling-state-handers" title="Direct link to heading">​</a></h2><p>Each state has up to 6 handler functions: <code>enter</code>, <code>post</code>, <code>exit</code>, <code>trans</code>, <code>code</code>, and <code>event</code>. In order for the decompiler to recognize these, you <em>must</em> have the top-level function decompile. Do not attempt to decompile these functions until the top-level function passes.</p><p>The top-level analysis will find state handlers and name them appropriately.  For non-virtual states, they will be named like <code>(&lt;handler-name&gt; &lt;state-name&gt;)</code>. Like <code>(code teetertotter-launch)</code>. For virtual states, the name will be <code>(&lt;handler-name&gt; &lt;state-name&gt; &lt;type-name&gt;)</code>.  Use these names in type casts, stack structures, etc. These names will not work unless the top-level has been decompiled.</p><p>The type of the state handlers will be set up automatically by the type system, but requires that you get the type of the state itself correct.</p><p>Note: inside of <code>find_defstates.cpp</code> there is an option to enable rename prints that will print out the old name of the function before the rename.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state-types">State Types<a class="hash-link" href="#state-types" title="Direct link to heading">​</a></h2><p>Each state object must have its type set.  The type of a state is:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(state &lt;arg0&gt; &lt;arg1&gt; ... &lt;parent-type&gt;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The args are the arguments given to the enter/code function. Both enter and code get the same arguments, and some may be unused, but this is ok.</p><p>The parent type is the type that the state belongs to.  It must be <code>process</code> or a child of <code>process</code>.  All state handlers are automatically behaviors of this type.</p><p>Here are two examples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(define-extern silostep-rise (state symbol silostep))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>will make all the <code>silostep-rise</code> handlers a behavior of <code>silostep</code> and will make <code>enter</code> and <code>code</code> take a single <code>symbol</code> argument.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="go">Go<a class="hash-link" href="#go" title="Direct link to heading">​</a></h2><p>The <code>go</code> macro changes state. Internally it uses <code>enter-state</code>.  Do not insert casts for <code>go</code>, it should work automatically.</p><p>TODO: there may be issues with the decompiler casting arguments to <code>go</code> - this is a bit tricky and I couldn&#x27;t find a test case yet.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="special-cases-for-virtual-states">Special Cases for Virtual States<a class="hash-link" href="#special-cases-for-virtual-states" title="Direct link to heading">​</a></h2><p>There are a few special cases for virtual states.</p><ol><li>The state must be declared in the <code>deftype</code>, within the list of methods.</li><li>The name of the method must be correct.</li><li>Any <code>go</code> should be in a behavior of the appropriate process.</li></ol><p>The next three sections explain these in more detail</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="declaring-a-virtual-state">Declaring a virtual state<a class="hash-link" href="#declaring-a-virtual-state" title="Direct link to heading">​</a></h3><p>Do not use <code>define-extern</code> to declare a virtual state.  Instead, use the method list in the <code>deftype</code>.</p><p>As an example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lui v1, L30               ;; [ 25] (set! gp-0 L30) [] -&gt; [gp: state ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ori gp, v1, L30</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lw t9, inherit-state(s7)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    or a0, gp, r0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lw v1, plat-button(s7)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lwu a1, 104(v1)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    jalr ra, t9</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sll v0, ra, 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lw t9, method-set!(s7)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lw a0, sunken-elevator(s7)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    addiu a1, r0, 22</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    or a2, gp, r0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    jalr ra, t9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This means</p><ul><li>The state object is <code>L30</code>.</li><li>The state is for type <code>sunken-elevator</code>.</li><li>The parent type of <code>sunken-elevator</code> should be <code>plat-button</code></li><li>The method ID is 22.</li></ul><p>The correct declaration should go under <code>:methods</code>. Like a normal method, it only needs to be defined in the parent type that first defines it. So we only have to put it in <code>plat-button</code> and can leave it out of <code>sunken-elevator</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(plat-button-pressed () _type_ :state 22)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The first thing is the state name (described more in the next section).  The next thing is a list of argument types given to the <code>enter</code> and <code>code</code> functions.</p><p>The ID should match the ID given to <code>method-set!</code> and it will be checked just like the normal method IDs.</p><p>If you get this wrong, you will get an error message like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">virtual defstate attempted on something that isn&#x27;t a state: (the-as state (method-of-type plat-button plat-button-move-upward))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Did you forget to put :state in the method declaration?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>which means that the <code>plat-button-move-upward</code> entry in <code>:methods</code> in <code>(deftype plat-button</code> is missing the <code>:state</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="name-of-a-virtual-state">Name of a virtual state<a class="hash-link" href="#name-of-a-virtual-state" title="Direct link to heading">​</a></h3><p>The decompiler will check that the name in the method is correct.  If you get it wrong, there will be an error that tells you the right name.</p><p>For example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Disagreement between state name and type system name. The state is named plat-button-move-upward, but the slot is named dummy-24, defined in type plat-button</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This means you should rename <code>dummy-24</code> in <code>plat-button</code> to <code>plat-button-move-upward</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="go-to-a-virtual-state">Go to a virtual state<a class="hash-link" href="#go-to-a-virtual-state" title="Direct link to heading">​</a></h3><p>You must be in a behavior in order for <code>go-virtual</code> to decompile successfully.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-return-value-of-event-problem">The return value of <code>event</code> problem.<a class="hash-link" href="#the-return-value-of-event-problem" title="Direct link to heading">​</a></h2><p>There is one place that seems to rely on the return value of <code>event</code>. As a result, the default is to assume that <code>event</code> returns an <code>object</code>. However, there are sometimes <code>event</code> functions that clearly don&#x27;t return a value and will refuse to decompile.  The recommendation is:</p><ul><li>Try to make all <code>event</code> functions return a value.</li><li>If it is absolutely not possible, make the function type return <code>none</code>, then the defstate should automatically insert a cast.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unsupported">Unsupported<a class="hash-link" href="#unsupported" title="Direct link to heading">​</a></h2><p>Calls to <code>find-parent-method</code> that actually return a <code>state</code> will have type <code>function</code>. You must manually cast it. Make sure you get the argument types correct. This same problem exists for finding methods, but it has been very rare. If needed we can add special support in the decompiler/compiler to make this work.</p><p>If there is a function with multiple virtual <code>go</code>s which assume a different type at compile-time (accessing different parts of the type tree), then it is not possible to insert the right kind of cast yet.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/open-goal/open-goal.github.io/tree/master/documentation/reference/decompiler_states.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/reference/process_and_state"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Process and State</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/usage"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Usage</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-can-i-tell-if-a-file-has-states" class="table-of-contents__link toc-highlight">How can I tell if a file has states?</a></li><li><a href="#virtual-vs-non-virtual-states" class="table-of-contents__link toc-highlight">Virtual vs. Non-Virtual States</a></li><li><a href="#decompiling-state-handers" class="table-of-contents__link toc-highlight">Decompiling state handers</a></li><li><a href="#state-types" class="table-of-contents__link toc-highlight">State Types</a></li><li><a href="#go" class="table-of-contents__link toc-highlight">Go</a></li><li><a href="#special-cases-for-virtual-states" class="table-of-contents__link toc-highlight">Special Cases for Virtual States</a><ul><li><a href="#declaring-a-virtual-state" class="table-of-contents__link toc-highlight">Declaring a virtual state</a></li><li><a href="#name-of-a-virtual-state" class="table-of-contents__link toc-highlight">Name of a virtual state</a></li><li><a href="#go-to-a-virtual-state" class="table-of-contents__link toc-highlight">Go to a virtual state</a></li></ul></li><li><a href="#the-return-value-of-event-problem" class="table-of-contents__link toc-highlight">The return value of <code>event</code> problem.</a></li><li><a href="#unsupported" class="table-of-contents__link toc-highlight">Unsupported</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 OpenGOAL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b80e7d5d.js"></script>
<script src="/assets/js/main.1d3489b1.js"></script>
</body>
</html>