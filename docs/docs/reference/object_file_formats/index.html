<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-reference/object_file_formats">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="OpenGOAL" href="/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/themes/dark.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<script src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/shoelace.js" type="module"></script><title data-rh="true">Object File Formats | OpenGOAL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://open-goal.github.io/docs/reference/object_file_formats"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Object File Formats | OpenGOAL"><meta data-rh="true" name="description" content="CGO/DGO Files"><meta data-rh="true" property="og:description" content="CGO/DGO Files"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://open-goal.github.io/docs/reference/object_file_formats"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/reference/object_file_formats" hreflang="en"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/reference/object_file_formats" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YAP33BKRCA-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.a5a42e0f.css">
<link rel="preload" href="/assets/js/runtime~main.f3288f23.js" as="script">
<link rel="preload" href="/assets/js/main.b2540e2b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OpenGOAL</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/progress/milestones">Progress</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/progress/milestones">Major Milestones</a></li><li><a class="dropdown__link" href="/progress/jak1">Jak 1 - Decompilation</a></li><li><a class="dropdown__link" href="/progress/jak2">Jak 2 - Decompilation</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/open-goal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">An Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/language-reference">Language Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Language Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/type_system">OpenGOAL&#x27;s Type System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/method_system">OpenGOAL&#x27;s Method System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/syntax">OpenGOAL Syntax &amp; Examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/lib">Standard Library</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/reader">Reader</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/goos">GOOS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/reference/object_file_formats">Object File Formats</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/process_and_state">Process and State</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/decompiler_states">States in the Decompiler</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/usage">Usage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Usage&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/developing">Developing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/pc-porting-info">PC Porting Info</a><button aria-label="Toggle the collapsible sidebar category &#x27;PC Porting Info&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/language-reference"><span itemprop="name">Language Reference</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Object File Formats</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Object File Formats</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cgodgo-files">CGO/DGO Files<a class="hash-link" href="#cgodgo-files" title="Direct link to heading">​</a></h2><p>The CGO/DGO file format is exactly the same - the only difference is the name of the file.  The DGO name indicates that the file contains all the data for a level. The engine will load these files into a level heap, which can then be cleared and replaced with a different level.</p><p>I suspect that the DGO file name came first, as a package containing all the data in the level which can be loaded very quickly.  Names in the code all say <code>dgo</code>, and the <code>MakeFileName</code> system shows that both CGO and DGO files are stored in the <code>game/dgo</code> folder.  Probably the engine and kernel were packed into a CGO file after the file format was created for loading levels.</p><p>Each CGO/DGO file contains a bunch of individual object files.  Each file has a name.  There are some duplicate names - sometimes the two files with the same names are very different (example, code for an enemy, art for an enemy), and other times they are very similar (tiny differences in code/data). The files come in two versions, v4 and v3, and both CGOs and DGOs contain both versions.  If an object file has code in it, it is always a v3.  It is possible to have a v3 file with just data, but usually the data is pretty small. The v4 files tend to have a lot of data in them.  My theory is that the compiler creates v3 files out of GOAL source code files, and that other tools for creating things like textures/levels/art-groups generate v4 objects.  There are a number of optimizations in the loading process for v4 objects that are better suited for larger files.  To stay at 60 fps always, a v3 object must be smaller than around 750 kB. A v4 object does not have this limitation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-v3-format">The V3 format<a class="hash-link" href="#the-v3-format" title="Direct link to heading">​</a></h3><p>The v3 format is divided into three segments:</p><ol><li>Main: this contains all of the functions/data that will be used by the game.</li><li>Debug: this is only loaded in debug mode, and is always stored on a separate <code>kdebugheap</code>.</li><li>Top Level: this contains some initialization code to add functions/variables to the symbol table, and any user-written initialization.  It runs once, immediately after the object is loaded, then is thrown away.</li></ol><p>Each segment also has linking data, which tells the linker how to link references to symbols, types, and memory (possibly in a different segment).</p><p>This format will be different between the PC and PS2 versions, as linking data for x86-64 will need to look different from MIPS.</p><p>Each segment can contain functions and data. The top-level segment must start with a function which will be run to initialize the object.  All the data here goes through the GOAL compiler and type system.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-v4-format">The V4 format<a class="hash-link" href="#the-v4-format" title="Direct link to heading">​</a></h3><p>The V4 format contains just data. Like v3, the data is GOAL objects, but was probably generated by a tool that wasn&#x27;t the compiler. A V4 object has no segments, but must start with a <code>basic</code> object.  After being linked, the <code>relocate</code> method of this <code>basic</code> will be called, which should do any additional linking required for the specific object.</p><p>Because this is just data, there&#x27;s no reason for the PC version to change this format. This means we can also check the</p><p>Note: you may see references to v2 format in the code. I believe v4 format is identical to v2, except the linking data is stored at the end, to enable a &quot;don&#x27;t copy the last object&quot; optimization. The game&#x27;s code uses the <code>work_v2</code> function on v4 objects as a result, and some of my comments may refer to v2, when I really mean v4.  I believe there are no v2 objects in any games.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-plan">The Plan<a class="hash-link" href="#the-plan" title="Direct link to heading">​</a></h3><ul><li>Create a library for generating obj files in V3/V4 format<ul><li>V4 should match game exactly. Doesn&#x27;t support code.</li><li>V3 is our own thing. Must support code.</li></ul></li></ul><p>We&#x27;ll eventually create tools which use the library in V4 mode to generate object files for rebuilding levels and textures.  We may need to wait until more about these formats is understood before trying this.</p><p>The compiler will use the library in V3 mode to generate object files for each <code>gc</code> (GOAL source code) file.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cgo-files">CGO files<a class="hash-link" href="#cgo-files" title="Direct link to heading">​</a></h3><p>The only CGO files read are <code>KERNEL.CGO</code> and <code>GAME.CGO</code>.</p><p> The <code>KERNEL.CGO</code> file contains the GOAL kernel and some very basic libraries (<code>gcommon</code>, <code>gstring</code>, <code>gstate</code>, ...). I believe that <code>KERNEL</code> was always loaded on boot during development, as its required for the Listener to function.</p><p>The <code>GAME.CGO</code> file combines the contents of the <code>ENGINE</code>, <code>COMMON</code> and <code>ART</code> CGO files.  <code>ENGINE</code> contains the game engine code, <code>COMMON</code> contains level-specific code (outside of the game engine) that is always loaded.  If code is used in basically all the levels, it makes sense to put in in <code>COMMON</code>, so it doesn&#x27;t have to be loaded for each currently active level.  The <code>ART</code> CGO contains common art/textures/models, like Jak and his animations.</p><p>The <code>JUNGLE.CGO</code>, <code>MAINCAVE.CGO</code>, <code>SUNKEN.CGO</code> file contains some copies of files used in the jungle, cave, LPC levels. Some are a tiny bit different. I believe it is unused.</p><p>The <code>L1.CGO</code> file contains basically all the level-specific code/Jak animations and some textures.  It doesn&#x27;t seem to contain any 3D models.  It&#x27;s unused, but I&#x27;m still interested in understanding its format, as the Jak 1 demos have this file.</p><p>The <code>RACERP.CGO</code> file contains (I think) everything needed for the Zoomer. Unused. The same data appears in the levels as needed, maybe with some slight differences.</p><p>The <code>VILLAGEP.CGO</code> file contains common code shared in village levels, which isn&#x27;t much (oracle, warp gate). Unused. The same data appears in the levels as needed.</p><p>The <code>WATER-AN.CGO</code> file contains some small code/data for water animations. Unused. The same data appears in the levels as needed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cgodgo-loading-process">CGO/DGO Loading Process<a class="hash-link" href="#cgodgo-loading-process" title="Direct link to heading">​</a></h3><p>A CGO/DGO file is loaded onto a &quot;heap&quot;, which is just a chunk of contiguous memory.  The loading process is designed to be fast, and also able to fill the entire heap, and allow each object to allocate memory after it is loaded.  The process works like this:</p><ol><li>Two temporary buffers are allocated at the end of the heap. These are sized so that they can fit the largest object file, not including the last object file.</li><li>The IOP begins loading, and is permitted to load the first two object files to the two temporary buffers</li><li>The main CPU waits for the first object file to be loaded.</li><li>While the second object file being loaded, the first object is &quot;linked&quot;. The first step to linking is to copy the object file data from the temporary buffer to the bottom of the heap, kicking out all the other data in the process. The linking data is checked to see if it is in the top of the heap, and is moved there if it isn&#x27;t already. The run-once initialization code is copied to another temporary allocation on top of the heap and the debug data is copied to the debug heap.</li><li>Still, while the second object file is being loaded, the linker runs on the first object file.</li><li>Still, while the second object file is being loaded, the second object&#x27;s initialization code is run (located in top of the heap). The second object may allocate from this heap, and will get valid memory without creating gaps in the heap.</li><li>Memory allocated from the top during linking is freed.</li><li>The IOP is allowed to load into the first buffer again.</li><li>The main CPU waits for the second object to be loaded, if the IOP hasn&#x27;t finished yet.</li><li>This double-buffering pattern continues - while one object is loaded into a buffer, the other one will be copied to the bottom of the heap, linked, and initialized. When the second to last object is loaded, the IOP will wait an extra time until the main CPU has finished linking it until loading the last object (one additional wait) because the last object has a special case.</li><li>The last object will be loaded directly onto the bottom of the heap, as there may not be enough memory to use the temporary buffers and load the last object. The temporary buffers are freed.</li><li>If the last object is a v3, its linking data will be moved to the top-level, and the object data will be moved to fill in the gap left behind. If the last object is a v2, the main data will be at the beginning of the object data, so there is an optimization that will avoid copying the object data to save time, if the data is already close to being in the right place.</li></ol><p>Generally the last file in a level DGO will be the largest v4 object.  You can only have one file larger than a temporary buffer, and it must come last. The last file also doesn&#x27;t have to be copied after being loaded into memory if it is a v4.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="v3-max-size">V3 max size<a class="hash-link" href="#v3-max-size" title="Direct link to heading">​</a></h4><p>A V3 object is copied all at once with a single <code>ultimate-memcpy</code>.  Usually linking gets to run for around 3 to 5% of a total frame. The <code>ultimate-memcpy</code> routine does a to/from scratchpad transfer. In practice, mem/spr transfers are around 1800 MB/sec, and the data has to be copied twice, so the effective bandwidth is 900 MB/sec.</p><p><code>900 MB / second * (0.04 * 0.0167 seconds) = 601 kilobytes</code></p><p>This estimate is backed up by the the chunk size of the v4 copy routine, which copies one chunk per frame.  It picks 524 kB as the maximum amount that&#x27;s safe to copy per frame.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/open-goal/open-goal.github.io/tree/master/documentation/reference/object_file_formats.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/reference/goos"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">GOOS</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/reference/process_and_state"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Process and State</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#cgodgo-files" class="table-of-contents__link toc-highlight">CGO/DGO Files</a><ul><li><a href="#the-v3-format" class="table-of-contents__link toc-highlight">The V3 format</a></li><li><a href="#the-v4-format" class="table-of-contents__link toc-highlight">The V4 format</a></li><li><a href="#the-plan" class="table-of-contents__link toc-highlight">The Plan</a></li><li><a href="#cgo-files" class="table-of-contents__link toc-highlight">CGO files</a></li><li><a href="#cgodgo-loading-process" class="table-of-contents__link toc-highlight">CGO/DGO Loading Process</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 OpenGOAL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f3288f23.js"></script>
<script src="/assets/js/main.b2540e2b.js"></script>
</body>
</html>