<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-reference/process_and_state">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/shoelace.js" type="module"></script><title data-rh="true">Process and State | OpenGOAL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://open-goal.github.io/docs/reference/process_and_state"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Process and State | OpenGOAL"><meta data-rh="true" name="description" content="What is a process?"><meta data-rh="true" property="og:description" content="What is a process?"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://open-goal.github.io/docs/reference/process_and_state"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/reference/process_and_state" hreflang="en"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/reference/process_and_state" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.09ceced1.css">
<link rel="preload" href="/assets/js/runtime~main.b80e7d5d.js" as="script">
<link rel="preload" href="/assets/js/main.1d3489b1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OpenGOAL</b></a><a class="navbar__item navbar__link" href="/progress">Progress</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/open-goal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">An Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/language-reference">Language Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Language Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/type_system">OpenGOAL&#x27;s Type System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/method_system">OpenGOAL&#x27;s Method System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/syntax">OpenGOAL Syntax &amp; Examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/lib">Standard Library</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/reader">Reader</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/goos">GOOS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/object_file_formats">Object File Formats</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/reference/process_and_state">Process and State</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reference/decompiler_states">States in the Decompiler</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/usage">Usage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Usage&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/developing">Developing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/pc-port-info">PC Port Info</a><button aria-label="Toggle the collapsible sidebar category &#x27;PC Port Info&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/language-reference"><span itemprop="name">Language Reference</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Process and State</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Process and State</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-a-process">What is a <code>process</code>?<a class="hash-link" href="#what-is-a-process" title="Direct link to heading">​</a></h2><p>A <code>process</code> object stores the state of some in-game object and tells the GOAL kernel how to update this object on each frame.</p><p>For example, there is a process for Jak, a process for each orb, and a process for each enemy. There is also a process for the time-of-day system and the pause menu.</p><p>In most cases, <code>process</code> is used as a parent type for a specific game object.  For example, <code>money</code> (orb) is a child of <code>process-drawable</code>, which is a child of <code>process</code>.  A <code>process-drawable</code> is a process that can be drawn as part of the <code>drawable</code> system.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-does-a-process-store">What does a process store?<a class="hash-link" href="#what-does-a-process-store" title="Direct link to heading">​</a></h2><p>Each <code>process</code> stores a small amount (112 bytes) of metadata, fields from child classes, some unknown stuff, and a process heap.  The process heap will automatically contain the &quot;main thread&quot; of the process, which contains space to back up the stack and registers when the thread suspends.  You may also allocate objects on the process heap yourself (not supported in OpenGOAL yet).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-is-a-process-run">How is a process run?<a class="hash-link" href="#how-is-a-process-run" title="Direct link to heading">​</a></h2><p>The <code>process</code> class is a child of <code>process-tree</code>, which is a left-child right-sibling binary tree.  On each frame, the kernel iterates through the <code>*active-pool*</code> and runs each process.  Each run consists of three steps:</p><ul><li>Run the <code>trans-hook</code> of the process in a temporary stack.</li><li>Resume the main thread of the process.</li><li>After the main thread suspends, run the <code>post-hook</code>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-i-create-a-process">How do I create a process?<a class="hash-link" href="#how-do-i-create-a-process" title="Direct link to heading">​</a></h2><p>Setting up a process requires three steps:</p><ul><li>Getting an actual process object</li><li>&quot;Activating&quot; a process so it will be run by the kernel</li><li>Setting up the code for the process to run</li></ul><p>There are a few &quot;dead pools&quot; which contain process objects that are not in use.  The <code>*4k-dead-pool*</code> contains processes that are 4kb each.  There is also a dynamic pool called the <code>*nk-dead-pool*</code> that allows you to create dynamically sized processes. You must do all allocations during initialization with these processes because they automatically &quot;shrink&quot; their heap as small as possible.  Also, <code>*nk-dead-pool*</code> processes will be relocated in memory as part of the process GC system, so you must make sure that all objects on the process heap support relocation, and you must use a <code>handle</code> to safely refer to the process, not just a normal <code>process</code> reference.</p><p>For example, to get a process:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">gc&gt; (define *test-proc* (get-process *nk-dead-pool* process 1024))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#&lt;process process dead :state #f :stack -1904/1441188 :heap 0/1024 @ #x193454&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This shows that:</p><ul><li>The process name is <code>process</code> (just a temporary name, until we activate)</li><li>The status is <code>dead</code></li><li>The process is not in a <code>state</code>.</li><li>The stack is bogus because we don&#x27;t have a main thread yet.</li><li>We have used 0 out of 1024 bytes of our process heap.</li></ul><p>Next, we need to activate it:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(activate *test-proc* *active-pool* &#x27;hello *kernel-dram-stack*)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This means:</p><ul><li>We put it in the <code>*active-pool*</code>. We could specify another process in the <code>*active-pool*</code> if we wanted this to be a child process of an existing process.</li><li>Our name is <code>&#x27;hello</code>.</li><li>When we run code, it will run on the <code>*kernel-dram-stack*</code>.</li></ul><p>Now, if we <code>(print *test-proc*)</code> we will see:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#&lt;process hello ready :state #f :stack 0/256 :heap 384/1024 @ #x193454&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Indicating that we are &quot;ready&quot; to be initialized, and that we now have a correctly set up main thread/stack.</p><p>If we run <code>inspect</code>, it will print out all objects on the process heap, including our main thread:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ----</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        [001934c4] cpu-thread</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name: code</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            process: #&lt;process hello ready :state #f :stack 0/256 :heap 384/1024 @ #x193454&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            previous: #f</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            suspend-hook: #&lt;compiled function @ #x1679c4&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            resume-hook: #&lt;compiled function @ #x167b24&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            pc: #x0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            sp: #x170b30</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            stack-top: #x170b30</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            stack-size: 256</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            rreg[7] @ #x1934e8</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            freg[8] @ #x193520</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            stack[0] @ #x193540</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ----</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we want a reference to this process, we must create a handle.  For example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">gc&gt; (process-&gt;handle *test-proc*)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#&lt;handle :process #&lt;process hello ready :state #f :stack 0/256 :heap 384/1024 @ #x192fe4&gt; :pid 2&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>this is now a safe reference to this process, even if it is relocated or deactivated.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-i-make-a-process-do-something">How do I make a process do something?<a class="hash-link" href="#how-do-i-make-a-process-do-something" title="Direct link to heading">​</a></h2><p>The <code>state</code> system is used to control a process.  Each process can be in a <code>state</code>, which specifies what functions should run.  To switch states in the current process, use <code>go</code>.</p><p>For example, we can create a simple test state like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(defstate test-state (process)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    :enter (lambda () (format #t &quot;enter!~%&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    :exit (lambda () (format #t &quot;exit!~%&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    :trans (lambda () (format #t &quot;trans!~%&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    :post (lambda () (format #t &quot;post!~%&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    :code (lambda ()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            (dotimes (i 5)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              (format #t &quot;Code ~D~%&quot; i)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              (suspend)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            (process-deactivate)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    )</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>code</code> is the function to run in the main thread.  This code should <code>suspend</code> itself, and the kernel will resume it after the suspend on each frame. Once the process is done, it can call <code>process-deactivate</code>. This will cause it to exit the current state, immediately exit the <code>code</code>, and clean up the process, returning it to the dead pool.</p><p>To switch the process to this state, you can use the <code>run-now-in-process</code> to switch to the test process and run the given code.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(run-now-in-process *test-proc* (lambda () (go test-state)))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And you will see:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">enter!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">trans!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Code 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">post!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">trans!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Code 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">post!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">trans!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Code 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">post!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">trans!</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">exit!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note 1: After deactivation, the handle is no longer valid as the process is dead and it will print like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#&lt;handle :process #f :pid 2&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note 2: There is also a <code>run-next-time-in-process</code> that sets up the process to run your initialization stub function as the <code>code</code> on the next time the kernel iterates through the process tree.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="some-notes-on-the-current-process">Some notes on &quot;the current process&quot;<a class="hash-link" href="#some-notes-on-the-current-process" title="Direct link to heading">​</a></h2><p>When the kernel runs a process, it sets <code>(-&gt; *kernel-context* current-process)</code> and the <code>pp</code> register to that process.  This process is called the &quot;current kernel process&quot;.</p><p>This process may then &quot;run code in another process&quot;.  This can be done with <code>run-now-in-process</code>, by deactivating another process, or using <code>go</code> on another process.  This changes <code>pp</code>, but not the kernel context.  The process in <code>pp</code> is called the &quot;current pp process&quot;.</p><p>The value of the <code>pp</code> register determines the current process.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="some-notes-on-process-deactivate">Some notes on <code>process-deactivate</code><a class="hash-link" href="#some-notes-on-process-deactivate" title="Direct link to heading">​</a></h2><p>To stop a process, you can do call the <code>deactivate</code> method of that process.  The <code>process-deactivate</code> macro just does this for the current process.</p><p>This does the following:</p><ul><li>Set state to <code>dead-state</code>.</li><li>Calls <code>entity-deactivate-handler</code>, if you have an entity</li><li>Calls <code>exit</code> of states</li><li>Cleans up any pending <code>protect-frame</code> (calling them with pp set for the process)</li><li>Disconnects it from the <code>connection</code> system</li><li>Deactivates all children process</li><li>Returns itself to the pool</li><li>If you deactivated the process that the kernel-dispatcher started running, immediately bail out of the thread</li><li>If you deactivated during a <code>run-now-in-process</code>, immediately bail out of the initialization and return to caller of <code>run-now-in-process</code>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="some-notes-on-go">Some notes on <code>go</code>.<a class="hash-link" href="#some-notes-on-go" title="Direct link to heading">​</a></h2><p>The <code>go</code> macro is used to change the state of the current process.</p><p>If you use <code>go</code> when in <code>run-now-in-process</code>, it will immediately return to the caller of <code>run-now-in-process</code>, and the actual state change will happen on the next execution of the main thread of that process.</p><p>If you use <code>go-process</code> on another process, the <code>go-process</code> will return immediately and the state transition will happen on the next run of that process.</p><p>If you use <code>go</code> in the main thread, it will immediately transition states, run exits, enter, trans, and begin running the new state <code>code</code>.</p><p>If you use <code>go</code> in <code>trans</code> it will set up the next run of the main thread, then abandon the current <code>trans</code>.
If you use <code>go</code> in <code>post</code>, it will set up the next run of the main thread to transition, but not abandon the current <code>post</code>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/open-goal/open-goal.github.io/tree/master/documentation/reference/process_and_state.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/reference/object_file_formats"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Object File Formats</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/reference/decompiler_states"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">States in the Decompiler</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-a-process" class="table-of-contents__link toc-highlight">What is a <code>process</code>?</a></li><li><a href="#what-does-a-process-store" class="table-of-contents__link toc-highlight">What does a process store?</a></li><li><a href="#how-is-a-process-run" class="table-of-contents__link toc-highlight">How is a process run?</a></li><li><a href="#how-do-i-create-a-process" class="table-of-contents__link toc-highlight">How do I create a process?</a></li><li><a href="#how-do-i-make-a-process-do-something" class="table-of-contents__link toc-highlight">How do I make a process do something?</a></li><li><a href="#some-notes-on-the-current-process" class="table-of-contents__link toc-highlight">Some notes on &quot;the current process&quot;</a></li><li><a href="#some-notes-on-process-deactivate" class="table-of-contents__link toc-highlight">Some notes on <code>process-deactivate</code></a></li><li><a href="#some-notes-on-go" class="table-of-contents__link toc-highlight">Some notes on <code>go</code>.</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 OpenGOAL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b80e7d5d.js"></script>
<script src="/assets/js/main.1d3489b1.js"></script>
</body>
</html>