<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developing/porting_to_x86">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="OpenGOAL" href="/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/themes/dark.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<script src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.74/dist/shoelace.js" type="module"></script><title data-rh="true">Porting to x86 | OpenGOAL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://open-goal.github.io/docs/developing/porting_to_x86"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Porting to x86 | OpenGOAL"><meta data-rh="true" name="description" content="This document will keep track of stuff that needs to be ported or modified significantly for x86. Anything that uses PS2-specific hardware or relies on stuff in the C Kernel will need to be ported."><meta data-rh="true" property="og:description" content="This document will keep track of stuff that needs to be ported or modified significantly for x86. Anything that uses PS2-specific hardware or relies on stuff in the C Kernel will need to be ported."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://open-goal.github.io/docs/developing/porting_to_x86"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/developing/porting_to_x86" hreflang="en"><link data-rh="true" rel="alternate" href="https://open-goal.github.io/docs/developing/porting_to_x86" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YAP33BKRCA-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.a5a42e0f.css">
<link rel="preload" href="/assets/js/runtime~main.600585e5.js" as="script">
<link rel="preload" href="/assets/js/main.6bf7d2ea.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="OpenGOAL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OpenGOAL</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/progress/milestones">Progress</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/progress/milestones">Major Milestones</a></li><li><a class="dropdown__link" href="/progress/jak1">Jak 1 - Decompilation</a></li><li><a class="dropdown__link" href="/progress/jak2">Jak 2 - Decompilation</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/open-goal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">An Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/language-reference">Language Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Language Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/usage">Usage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Usage&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/developing">Developing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developing&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing/compiler_example">Compiler Example</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing/asm_emitter">Assembly Emitter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developing/porting_to_x86">Porting to x86</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developing/registers">Registers</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/pc-porting-info">PC Porting Info</a><button aria-label="Toggle the collapsible sidebar category &#x27;PC Porting Info&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/developing"><span itemprop="name">Developing</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Porting to x86</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Porting to x86</h1><p>This document will keep track of stuff that needs to be ported or modified significantly for x86. Anything that uses PS2-specific hardware or relies on stuff in the C Kernel will need to be ported.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-info">Basic Info<a class="hash-link" href="#basic-info" title="Direct link to heading">​</a></h2><p>Most of the game is written in GOAL. All this source lives in <code>goal_src</code>.</p><p>The &quot;runtime&quot; is all the support code written in C++. It&#x27;s located in <code>game/</code>. Sometimes the &quot;runtime&quot; + GOAL code together is called the &quot;target&quot;.</p><p>Most of the code in &quot;runtime&quot; is reverse engineered code from the real game, with small tweaks to make it work on x86 and with OpenGOAL.</p><p>The code in <code>game/system</code> is <strong>not</strong> from the game and is an implementation of system functions that are implemented by Sony in the PS2 game. It&#x27;s stuff like threading, I/O, etc.</p><p>The code in <code>game/sce</code> is my implementation of the Sony libraries. When possible, I tried to keep exactly the same names/functions as the real Sony libraries. This way our reverse engineered game code can look very similar to the original, which is satisfying and fun.</p><p>The PS2&#x27;s main CPU is called the EE. It runs GOAL code and the C Kernel, which is Naughty Dog&#x27;s C++ code.  The C Kernel is responsible for bootstrapping GOAL&#x27;s kernel and exposing Sony library functions to GOAL code.  The C Kernel is in <code>game/kernel</code>.  In OpenGOAL the &quot;EE Thread&quot; runs code than ran on the EE on the PS2. This includes the C Kernel and all GOAL code. There is a single EE thread - GOAL implements its own threading, but this all runs in the same Linux/Windows thread.</p><p>The PS2 has a separate I/O Processor called the IOP. It runs the OVERLORD driver written by Naughty Dog in C. OpenGOAL uses C++ for its implementation of OVERLORD. Like with the EE, there are Sony libraries for the IOP. These are in <code>game/sce/iop</code> to distinguish them from EE code. The IOP can run independently from the EE. Unlike the EE, the IOP itself has multiple threads (7 threads) that each have their own OS thread. But only one IOP thread runs at a time, as the IOP was a single-core CPU.</p><p>To give an idea of the size of these (counted by <code>wc -l</code>):</p><ul><li>OVERLORD is 3700 lines, but still has a lot to implement,</li><li>C Kernel is 7432 lines, and is mostly done</li><li>SCE is 973 lines, and still has some to implement</li><li>System is 1294 lines, and still has some to implement</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="math-libraries">Math Libraries<a class="hash-link" href="#math-libraries" title="Direct link to heading">​</a></h2><p>I think most of the math libraries can be decompiled, but there are a few that will need manual work. These are also a great place to do tests as the math functions have very few dependencies and we know what the right answer should be for many of them.</p><ul><li><code>bounding-box</code> (only some stuff)</li><li><code>math</code> (only <code>rand-uint31-gen</code>)</li><li><code>matrix</code> (only some stuff)</li><li><code>geometry</code> (only some stuff)</li><li><code>trigonometry</code> (only some stuff)</li></ul><p>At some point we may want to re-implement some of these to be more efficient.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-iop-io-processor-framework">The IOP (I/O Processor) Framework<a class="hash-link" href="#the-iop-io-processor-framework" title="Direct link to heading">​</a></h2><p>This is already implemented.</p><p>The IOP was a separate I/O Processor on the PS2. It runs a cooperative multi-tasking kernel developed by Sony. In OpenGOAL it is implemented in <code>game/system/IOP_Kernel.h</code>.  The IOP Kernel is managed by the IOP runtime thread (<code>game/system/iop_thread.h</code>).</p><p>The library in <code>game/sce/iop.h</code> wraps the <code>IOP_Kernel</code> in an interface that looks like the Sony libraries used by the game so the IOP code can be ported directly.</p><p>There are a few stub functions that are hardcoded to return the correct values for stuff like CD drive initialization.  The main features currently supported are:</p><ul><li>Threads (create, wakeup, start, sleep, delay, get ID)</li><li>Messageboxes to pass data between threads (send, poll)</li><li>SIF RPC, a library to receive remote procedure calls from the EE. See <code>game/sce/sif_ee.h</code> for the wrapper of the EE side library, and <code>game/kernel/kdgo.cpp</code> and <code>ksound.cpp</code> for the wrapper around the EE library that&#x27;s exposed to GOAL.</li><li>DMA to the EE for sending data from the IOP to GOAL.</li></ul><p>All this stuff is currently used for loading DGOs, which is tested and working.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overlord-framework">OVERLORD Framework<a class="hash-link" href="#overlord-framework" title="Direct link to heading">​</a></h2><p>This is already implemented.</p><p>The OVERLORD is the code written by Naughty Dog that runs on the IOP. It is responsible for sound and loading data.  It&#x27;s surprisingly complicated and some parts of it are extremely poorly written, especially the thread synchronization stuff.  My implementation of OVERLORD is in <code>game/overlord</code>. It&#x27;s not complete yet, but the basics are there and it does enough to load DGOs.</p><p>The framework for OVERLORD is already implemented. The C Kernel calls a Sony library function to load OVERLORD. This library function is <code>sceSifLoadModule</code>, implemented in <code>sif_ee.cpp</code>, which tells the IOP Kernel code to start.  This starts up the OVERLORD thread which eventually calls <code>start_overlord</code> in <code>game/overlord/overlord.cpp</code>.  This <code>start_overlord</code> function is the entry point to Naughty Dog&#x27;s OVERLORD library and starts a bunch more threads (see <code>InitISOFS</code>), using the Sony IOP library.  In total there are 7 threads.</p><p>Once <code>start_overlord</code> returns, the initial call to <code>sceSifLoadModule</code> returns and the runtime keeps initializing.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overlord-iso-thread">OVERLORD ISO Thread<a class="hash-link" href="#overlord-iso-thread" title="Direct link to heading">​</a></h2><p>This is partially implemented.</p><p>This thread is responsible for controlling the DVD drive and the small DVD data buffers used in the IOP. It has a big loop in <code>ISOThread()</code> in <code>iso.cpp</code> that looks for pending reads, executes them, waits for data to be read, then calls a callback.  This code is unbelievably confusing.</p><p>It receives commands from other OVERLORD threads (using a MessageBox) and uses the priority queue implemented in <code>iso_queue.cpp</code> to decide which read gets to go first.</p><p>To interact with the DVD drive, it uses an <code>IsoFS</code> abstraction, which is a struct containing function pointers to control the drive. The version of OVERLORD in the retail game has only one implemented, called <code>iso_cd</code> which uses the actual drive in the PS2. There&#x27;s also a reference to <code>fakeiso</code>, but this is empty in the game. Instead of &quot;emulating&quot; the CD drive functions, I implemented my own version of <code>fakeiso</code> mode in <code>fake_iso.cpp</code>.  This just reads files from your hard drive and uses the <code>fakeiso.txt</code> file to map files in the <code>jak-project</code> folder to OVERLORD file names (it has it&#x27;s own system for naming files).</p><p>It also has some sound stuff in it for managing VAG audio streams, but this isn&#x27;t implemented yet.</p><p>The other threads in OVERLORD are &quot;RPC&quot; threads. They sit in a loop waiting for the main runtime thread (EE thread) to send a remote procedure call (RPC). Then they do something (like maybe sending a message to the ISO thread), maybe wait for something to happen, and then return.</p><p>From the GOAL/EE side of things, RPC calls can be blocking or non-blocking. They can be issued from GOAL (with <code>rpc-call</code>) or from the C Kernel (<code>RpcCall</code>). Per &quot;channel&quot; (corresponds to an IOP thread), there can only be one RPC call happening at a time. The <code>rpc-busy?</code> command can be used to check if an RPC is complete.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iop-play-6">IOP PLAY (6)<a class="hash-link" href="#iop-play-6" title="Direct link to heading">​</a></h2><p>This is unimplemented.</p><p>The <code>PLAY</code> RPC appears to be relatively simple and plays/stops/pauses/queues a VAG audio stream. It can either use the &quot;AnimationName&quot; system or another system to get the name of the audio stream.  I don&#x27;t know what sound effects in the game are streamed, but I believe there are some.</p><p>I suspect the GOAL side code for this is in <code>gsound</code> and <code>gsound-h</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iop-str-5">IOP STR (5)<a class="hash-link" href="#iop-str-5" title="Direct link to heading">​</a></h2><p>This is unimplemented.</p><p>This is an RPC for streaming data back to the EE. I think this is used to control animation streaming.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iop-dgo-4">IOP DGO (4)<a class="hash-link" href="#iop-dgo-4" title="Direct link to heading">​</a></h2><p>This is implemented.</p><p>This is the RPC for loading DGO files.  The DGO loading is super complicated, but the basic idea is that loading / linking are double buffered. In order to allow linking files to allocate memory, the currently loading file goes in a temporary buffer on the top of the heap. (There are actually two temp buffers that rotate, one for loading out of and one for linking, as the &quot;copy to heap&quot; step is done as part of linking, not loading)</p><p>The final chunk is not double buffered. This is so it can be loaded directly into its final location in the heap. This has three advantages: you don&#x27;t need to copy it out of a temporary buffer, you can have a file larger than the temp buffer and you can also entirely fill the heap this way (the temp buffers are freed so you don&#x27;t have to worry about that).</p><p>The IOP side state machine for this is in <code>iso.cpp</code>, implemented inside of the DGO load buffer complete callback and is somewhat complicated because DGO info may be split between multiple buffers, and you have to deal with getting partial info.  The EE side is in <code>kdgo.cpp</code>.</p><p>The DGO synchronization is pretty confusing but I believe I have it working. It may be worth documenting it more (I thought I did already, but where did I put it?).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iop-serverramdisk-3">IOP Server/Ramdisk (3)<a class="hash-link" href="#iop-serverramdisk-3" title="Direct link to heading">​</a></h2><p>This is implemented, but so far unused and untested.</p><p>This RPC is used to store files in RAM on the IOP. There&#x27;s a buffer of around 800 kB. I believe it&#x27;s used for a few different things, in particular the level visibility data. The EE requests data to be loaded from a file on DVD into the &quot;ramdisk&quot; (just a buffer on the IOP), then can request chunks of this file. Of course it is not as fast as storing the file in the EE RAM, but it is much faster than reading from the DVD again.</p><p>This is what Andy Gavin refers to when they said they did &quot;things they weren&#x27;t supposed to&quot; with the &quot;one megabyte of memory that wasn&#x27;t being used&quot;.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iop-loader-2">IOP Loader (2)<a class="hash-link" href="#iop-loader-2" title="Direct link to heading">​</a></h2><p>This is unimplemented.</p><p>This is used to control the loading of music and soundbanks. I haven&#x27;t touched it yet.  Music and soundbanks are loaded into IOP memory when you switch levels.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iop-player-1">IOP Player (1)<a class="hash-link" href="#iop-player-1" title="Direct link to heading">​</a></h2><p>This is unimplemented.</p><p>This is used to control the playing of sound, and goes with Loader. Like PLAY it can play VAG audio streams. I&#x27;m not sure which one is actually used for streaming audio, maybe both?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iop-vblank-handler">IOP VBlank Handler<a class="hash-link" href="#iop-vblank-handler" title="Direct link to heading">​</a></h2><p>This is unimplemented.</p><p>The IOP&#x27;s kernel will call <code>VBlank_Handler</code> on each vblank. This is once per frame, and I don&#x27;t know where it is, or if its tied to the actual HW vblank or framebuffer swap, if it happens at 30/60 fps (or even/odd frames if 30 fps). I suspect it&#x27;s the real vblank at 60 fps but I don&#x27;t know.</p><p>This does some music fade calculations and sends some data to the EE.  In GOAL this is called the <code>sound-iop-info</code>.</p><p>The EE first has to do some set up to tell the IOP where to copy the data, which I believe is done in another sound RPC from GOAL.</p><p>We&#x27;ll also need to add some stuff to <code>system</code> and <code>sce/iop</code> to set this up, which will have to work with frame timing stuff so it happens at the right part of the frame.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sound-library">Sound Library<a class="hash-link" href="#sound-library" title="Direct link to heading">​</a></h2><p>This is a pretty big one. To actually make sounds, OVERLORD code uses a third-party sound library called 989SND. Internally 989SND uses the SPU2 (Sound Processor) to actually do the &quot;sound math&quot; to decode ADPCM, do ADSR for the sampled sounds, and do reverb/mixing.</p><p>I think the lowest effort sound implementation is to try to reimplement 989SND + the SPU as a single library.  This could be tested and developed in isolation from everything else.</p><p>We&#x27;ll also need to pick a library for doing audio on PC and a design for how to keep the audio in sync. My gut feeling is to let the IOP side audio stuff just run totally independent from everything else, like the real game does. Let the audio sampling be driven by the sound device so you never have any crackling/interpolation artifacts. This is why the audio keeps going even after the game crashes on PS2.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="goal-kernel">GOAL Kernel<a class="hash-link" href="#goal-kernel" title="Direct link to heading">​</a></h2><p>The GOAL kernel needs some modification to work on x86. It implements userspace threading and needs to know the details of how to back up the current CPU state and restore it.  It also needs to work with the compiler to make sure that the kernel and compiler agree on what registers may not be preserved across a thread suspend  There are also some CPU specific details on how to do dynamic throw/catches, unwinding stack frames, and passing initial arguments to a thread.</p><p>In OpenGOAL, the <code>rsp</code> is a &quot;real&quot; pointer and all other pointers are &quot;GOAL pointer&quot;s (offset from base of GOAL memory), so there are some details needed to correctly save/restore stacks.</p><p>A final detail is we will probably want/need the ability to increase the default size of stack that can be backed up on suspend. The default is 256 bytes so if our compiler does worse than the original and we use more stack space, we could run out. There&#x27;s a check for this so it shouldn&#x27;t be hard to detect.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="jak-graphics-basics">Jak Graphics Basics<a class="hash-link" href="#jak-graphics-basics" title="Direct link to heading">​</a></h2><p>The PS2 has some special hardware that&#x27;s used for graphics. These are the DMAC, the VU1, and the GS.</p><p>The DMAC is a sophisticated DMA controller. It runs separately from the EE and can copy data from one place to another at pretty high speed. If it is not stalled for any reason it can reach 2.4 GB/sec.  The main RAM is only good for around 1.2 GB/sec so in practice &quot;big&quot; things don&#x27;t move around any faster than 1.2 GB/sec on average. It&#x27;s used to send graphics data from main memory to the other components.  It can be configured, but it&#x27;s not programmable. It can do simple transfers, like &quot;copy this block of data from here to there&quot;, and more complicated things, like following linked lists.</p><p>The VU1 takes the role of vertex shaders. It can be programmed, but only in assembly, and it is extremely challenging and confusing. It has an extremely small memory (16 kB), but this memory is extremely fast. It&#x27;s role is usually to do vertex transformations and lighting, then generate a list of commands to send to the GS.  The <code>XGKICK</code> instruction on VU1 is used to send data from the VU1 memory to the GS.</p><p>The GS is the actual GPU. It has VRAM and receives commands from a few different places, including:</p><ul><li>VU1 <code>XGKICK</code>s stuff to it directly, bypassing the main bus used by DMAC/CPU memory access. This is called PATH 1 and is most commonly used in Jak 1.</li><li>When DMAing stuff to VU1, it first goes through a thing called VIF1 which can &quot;unpack&quot; data.  There is a special command that you can give to VIF1 which tells it to &quot;send data directly to the GS&quot;.</li><li>DMA sends data directly from EE main memory to GS (Path 3), unused by Jak 1</li></ul><p>The GS is like pixel shaders but it&#x27;s very simple - it&#x27;s not programmable and only can do a few fixed things. The GS also has the VRAM, which can contain frame buffers, z buffers, textures, and scratch area for effects.</p><p>My understanding is that during a frame, the EE generates a long list of things to draw. These are a DMA &quot;chain&quot; - basically a complicated linked-list like data structure that the PS2&#x27;s DMA knows how to handle.  I believe some graphics calculations are done on the EE - particularly the environment mapping.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dma">DMA<a class="hash-link" href="#dma" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="display">Display<a class="hash-link" href="#display" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="texture">Texture<a class="hash-link" href="#texture" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="collision-system">Collision System<a class="hash-link" href="#collision-system" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="joint">Joint<a class="hash-link" href="#joint" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bsp">BSP<a class="hash-link" href="#bsp" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="merc-blend-shape">Merc Blend Shape<a class="hash-link" href="#merc-blend-shape" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ripple">Ripple<a class="hash-link" href="#ripple" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bones">Bones<a class="hash-link" href="#bones" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="generic-merc">Generic Merc<a class="hash-link" href="#generic-merc" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="generic-tie">Generic TIE<a class="hash-link" href="#generic-tie" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="shadow">Shadow<a class="hash-link" href="#shadow" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="font">Font<a class="hash-link" href="#font" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decompression">Decompression<a class="hash-link" href="#decompression" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a class="hash-link" href="#background" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="draw-node-culling">Draw Node Culling<a class="hash-link" href="#draw-node-culling" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="shrubbery">Shrubbery<a class="hash-link" href="#shrubbery" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tfrag">TFRAG<a class="hash-link" href="#tfrag" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tie">TIE<a class="hash-link" href="#tie" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="particle">Particle<a class="hash-link" href="#particle" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="time-of-day">Time of Day<a class="hash-link" href="#time-of-day" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sky">Sky<a class="hash-link" href="#sky" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="load-boundary">Load boundary<a class="hash-link" href="#load-boundary" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sound">Sound<a class="hash-link" href="#sound" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="controllers">Controllers<a class="hash-link" href="#controllers" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iop-streaming">IOP Streaming<a class="hash-link" href="#iop-streaming" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ocean">Ocean<a class="hash-link" href="#ocean" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="navigate">Navigate<a class="hash-link" href="#navigate" title="Direct link to heading">​</a></h2></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/open-goal/open-goal.github.io/tree/master/documentation/developing/porting_to_x86.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developing/asm_emitter"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Assembly Emitter</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developing/registers"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Registers</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#basic-info" class="table-of-contents__link toc-highlight">Basic Info</a></li><li><a href="#math-libraries" class="table-of-contents__link toc-highlight">Math Libraries</a></li><li><a href="#the-iop-io-processor-framework" class="table-of-contents__link toc-highlight">The IOP (I/O Processor) Framework</a></li><li><a href="#overlord-framework" class="table-of-contents__link toc-highlight">OVERLORD Framework</a></li><li><a href="#overlord-iso-thread" class="table-of-contents__link toc-highlight">OVERLORD ISO Thread</a></li><li><a href="#iop-play-6" class="table-of-contents__link toc-highlight">IOP PLAY (6)</a></li><li><a href="#iop-str-5" class="table-of-contents__link toc-highlight">IOP STR (5)</a></li><li><a href="#iop-dgo-4" class="table-of-contents__link toc-highlight">IOP DGO (4)</a></li><li><a href="#iop-serverramdisk-3" class="table-of-contents__link toc-highlight">IOP Server/Ramdisk (3)</a></li><li><a href="#iop-loader-2" class="table-of-contents__link toc-highlight">IOP Loader (2)</a></li><li><a href="#iop-player-1" class="table-of-contents__link toc-highlight">IOP Player (1)</a></li><li><a href="#iop-vblank-handler" class="table-of-contents__link toc-highlight">IOP VBlank Handler</a></li><li><a href="#sound-library" class="table-of-contents__link toc-highlight">Sound Library</a></li><li><a href="#goal-kernel" class="table-of-contents__link toc-highlight">GOAL Kernel</a></li><li><a href="#jak-graphics-basics" class="table-of-contents__link toc-highlight">Jak Graphics Basics</a></li><li><a href="#dma" class="table-of-contents__link toc-highlight">DMA</a></li><li><a href="#display" class="table-of-contents__link toc-highlight">Display</a></li><li><a href="#texture" class="table-of-contents__link toc-highlight">Texture</a></li><li><a href="#collision-system" class="table-of-contents__link toc-highlight">Collision System</a></li><li><a href="#joint" class="table-of-contents__link toc-highlight">Joint</a></li><li><a href="#bsp" class="table-of-contents__link toc-highlight">BSP</a></li><li><a href="#merc-blend-shape" class="table-of-contents__link toc-highlight">Merc Blend Shape</a></li><li><a href="#ripple" class="table-of-contents__link toc-highlight">Ripple</a></li><li><a href="#bones" class="table-of-contents__link toc-highlight">Bones</a></li><li><a href="#generic-merc" class="table-of-contents__link toc-highlight">Generic Merc</a></li><li><a href="#generic-tie" class="table-of-contents__link toc-highlight">Generic TIE</a></li><li><a href="#shadow" class="table-of-contents__link toc-highlight">Shadow</a></li><li><a href="#font" class="table-of-contents__link toc-highlight">Font</a></li><li><a href="#decompression" class="table-of-contents__link toc-highlight">Decompression</a></li><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#draw-node-culling" class="table-of-contents__link toc-highlight">Draw Node Culling</a></li><li><a href="#shrubbery" class="table-of-contents__link toc-highlight">Shrubbery</a></li><li><a href="#tfrag" class="table-of-contents__link toc-highlight">TFRAG</a></li><li><a href="#tie" class="table-of-contents__link toc-highlight">TIE</a></li><li><a href="#particle" class="table-of-contents__link toc-highlight">Particle</a></li><li><a href="#time-of-day" class="table-of-contents__link toc-highlight">Time of Day</a></li><li><a href="#sky" class="table-of-contents__link toc-highlight">Sky</a></li><li><a href="#load-boundary" class="table-of-contents__link toc-highlight">Load boundary</a></li><li><a href="#sound" class="table-of-contents__link toc-highlight">Sound</a></li><li><a href="#controllers" class="table-of-contents__link toc-highlight">Controllers</a></li><li><a href="#iop-streaming" class="table-of-contents__link toc-highlight">IOP Streaming</a></li><li><a href="#ocean" class="table-of-contents__link toc-highlight">Ocean</a></li><li><a href="#navigate" class="table-of-contents__link toc-highlight">Navigate</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 OpenGOAL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.600585e5.js"></script>
<script src="/assets/js/main.6bf7d2ea.js"></script>
</body>
</html>